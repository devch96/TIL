# 데이터링크 계층

- 데이터링크 계층은 같은 네트워크에 있는 단말을 식별하고 물리 계층 위에서 비트열을 정확히 전송하는 구조를 제공함
- 데이터링크 계층은 디지털 데이터 전체의 정합성을 체크함으로써 물리 계층만으로는 정정할 수 없는 에러를 감지하고 디지털 데이터의
신뢰성을 담보함
- MAC 주소라는 네트워크상의 주소를 사용해서 송신 단말과 수신 단말을 식별함

------------

## 유선 LAN(IEEE802.3)

- 데이터링크란 인접한 기기 사이에 만드는 논리적인 전송로
- 데이터링크 계층은 어떤 단말에 대해 논리적인 전송로를 만드는가, 그리고 만들어진 링크 안에 비트가 누락되지는 않았는가를 판단하기 위해
캡슐화 처리로 물리 계층의 신뢰성을 확보함

### 이더넷의 프레임 포맷

- 이더넷에 의해 캡슐화된 패킷을 이더넷 프레임이라 부름
  - 이더넷 II 규약을 사용함
- 이더넷 II의 프레임 포맷은 프리앰블, 수신지/송신지 MAC 주소, 타입, 이더넷 페이로드, FCS 라는 5개 필드로 구성됨
  - 프리앰블, 수/송신지 MAC 주소, 타입을 합쳐 이더넷 헤더라 부름
  - FCS는 이더넷 트레일러라 부르기도 함

#### 프리앰블

- '이제부터 이더넷 프레임을 보낸다' 라는 합의를 의미하는 8바이트(64비트)의 특별한 비트 패턴
  - 앞에서부터 '10101010'을 7개(8*7=56), '10101011'을 1개(8) 보냄
- 수신 측 단말은 이더넷 프레임 최초에 부여되어 있는 이 특별한 비트 패턴을 보고 이제부터 이더넷 프레임이 온다라고 판단함

#### 수신지/송신지 MAC 주소

- MAC은 이더넷 네트워크에 접속하고 있는 단말을 식별하는 6바이트(48비트) ID
  - 주소와 같은 것
- 수신 측 단말은 수신지 MAC 주소를 보고 자신의 MAC 주소라면 해당 프레임을 받고 관계없는 MAC 주소라면 파기함

#### 타입

- 타입은 네트워크 계층(L3)에서 어떤 프로토콜을 사용하는지 나타내는 2바이트의 ID
- 사용하는 프로토콜이나 그 버전 등에 따라 값이 결정됨

#### 이더넷 페이로드

- 네트워크 계층의 데이터 자체를 나타냄
  - 이더넷 페이로드 = IP 패킷
- 디폴트로 46바이트부터 1,500 파이트 범위 안에 들어가야 함
  - 46바이트 미만인 경우 패딩이라는 더미 데이터를 추가해 강제로 46바이트로 만듬
  - 1500바이트 이상인 경우엔 트랜스포트 계층이나 네트워크 계층에서 데이터를 쪼개어 이하로 맞춤

#### FCS

- Frame Check Sequence는 이더넷 프레임이 손상되지 않았는지 확인하기 위한 4바이트 필드
- 송신 측 단말은 이더넷 프레임을 송신할 때 송신 정보(MAC 주소, 페이로드 등)에 대해 일정한 계산(체크섬 계산)을 수행하고 그 결과를
FCS로 프레임 마지막에 추가함
- 수신 측 단말은 전달받은 이더넷 프레임에 동일한 계산을 적용하고 그 값이 FCS와 같다면 올바른 이더넷 프레임이라고 판단
  - 값이 다르면 손상되었다고 판단하고 파기함

### MAC 주소

- 이더넷 네트워크에 접속되어 있는 단말의 식별 ID
- 6바이트로 구성되며 1바이트씩 하이픈이나 콜론으로 구분해 12자리의 16진수로 표기함
- MAC 주소는 고유한 값이 아니기 때문에 이더넷 네트워크에 같은 MAC 주소의 단말이 여럿 존재하면 통신할 수 없음.
  - 중복되지 않는 MAC 주소로 수정해야 함

#### 통신 종류에 따른 MAC 주소의 차이

- 이더넷 네트워크에서의 통신은 유니캐스트, 브로드캐스트, 멀티캐스트 3가지

#### 유니캐스트

- 1:1 통신
- 송수신하는 각 단말의 MAC 주소가 송신지 MAC 주소와 수신지 MAC 주소가 됨
- 웹, 메일 등 인터넷 통신의 대부분은 유니캐스트

#### 브로드캐스트

- 1:N 통신
  - N은 같은 이더넷 네트워크에 접속되어 있는 자신 외의 모든 단말
- 이 브로드캐스트가 도달하는 범위를 브로드캐스트 도메인이라 부름
- 브로드캐스트는 ARP와 같은 네트워크상의 모든 단말에 알림/문의를 하는 프로토콜에 사용됨
- 브로드캐스트 시 수신지 MAC 주소는 6바이트 모두 '1' (ff:ff:ff:ff)라는 값을 사용

#### 멀티캐스트

- 1:N 통신
  - N은 특정 그룹(멀티캐스트 그룹)에 속하는 단말
- 어떤 단말이 멀티캐스트를 송신하면 그 그룹에 있는 단말들만 패킷을 수신
- 보르드캐스트는 그 네트워크에 있는 모든 단말이 강제로 패킷을 수신하지만 멀티캐스트는 애플리케이션을 기동한 단말만 패킷을 수신할 수 있기 때문에
트래픽 효율이 높아짐

### L2 스위치

- 데이터링크 계층에서 동작하는 네트워크 기기

#### L2 스위칭

- L2 스위치는 이더넷 헤더에 포함된 송신지 MAC 주소와 자신의 포트 번호를 MAC 주소 테이블이라는 메모리상의 테이블로 관리하며
이더넷 프레임의 전송 대상지를 바꾸어 통신 효율을 높임
  - 전송 대상지를 바꾸는 기능을 L2 스위칭이라 함
  - 가장 기본적 기능

#### VLAN

- VLAN은 1대의 L2 스위치를 여러 대의 L2 스위치로 가상 분할하는 기술
- 포트 기반 VLAN
  - 하나의 포트에 하나의 VLAN을 할당하는 기능
- 태그 VLAN
  - 이더넷 프레임에 VLAN 정보를 VLAN 태그로 붙이는 기능

#### PoE

- PoE(Power over Ethernet)는 트위스트 페어 케이블을 사용해 전원을 공급하는 기능
- 천장, 벽 안쪽 등 전원 케이블이 닿지 않는 장소에 설치하는 액세스 포인트나 네트워크 카메라에 트위스트 케이블 하나로 전원과 데이터를
동시에 공급할 수 있음

------------

## 무선 LAN(IEEE 802.11)

### IEEE802.11 프레임의 프레임 포맷

- 전송 속도나 변조 방식 등 무선과 관련한 많은 제어 정보가 포함되어 있음
- 유선 LAN과 함께 존재하기 위해 MAC 주소의 필드가 4개로 증가됨

#### 프리앰블

- IEEE802.11 프레임을 보냅니다 라는 합의를 의미하는 가변 길이 필드

#### 프레임 제어

- 프레임 제어에 필요한 정보를 포함한 2바이트 필드
- 프레임의 종류나 송신지/수신지의 종류, 프래그먼트 정보, 전력 상태 등
- 무선 LAN의 프레임의 종류
  - 데이터 프레임
    - IP 패킷을 송수신하기 위한 프레임
  - 관리 프레임
    - 어떤 액세스 포인트와 어떻게 접속할 것인지 관리하는 프레임
  - 제어 프레임
    - 데이터 프레임의 전송을 돕기 위해 존재하는 프레임
    - ACK 프레임 사용

#### Duration/ID

- 무선 회선을 점유할 예정 시간의 알림이나 단말의 배터리 소비량을 제어하는 전원 관리 식별자에 사용되는 2바이트 필드

#### MAC 주소 1/2/3/4

- 최대 4개의 MAC 주소 필드를 가질 수 있어 프레임 종류나 네트워크 구성에 따라 그 수와 용도가 달라짐
- 데이터 프레임의 MAC 주소
  - 네트워크 구성에 따라 달라짐
  - 인프라 모드
    - 무선 LAN 단말이 반드시 액세스 포인트를 경유해 통신하는 네트워크 구성
    - 무선 구간의 수신지 MAC주소 / 무선 구간의 송신지 MAC 주소 / 무선 LAN 단말의 송신지 MAC 주소나 수신지 MAC 주소 / NULL
  - 애드혹 모드
    - 액세스 포인트를 거치지 않고 무선 LAN 단말끼리 직접 통신하는 네트워크 구성
    - 무선 구간의 수신지 AMC 주소 / 무선 구간의 송신지 MAC 주소 / 사용자가 정의한 ID / NULL
  - WDS 모드
    - 액세스 포인트끼리 통신하는 네트워크 구성
      - 무선 LAN으로 네트워크를 연장할 때 등에 사용
    - 무선 구간의 수신지 MAC 주소 / 무선 구간의 송신지 MAC 주소 / 수신지 MAC 주소 / 송신지 MAC 주소
- 관리 프레임의 MAC 주소
  - 무선 LAN 단말과 액세스 포인트에서만 교환되는 프레임
  - 무선 구간에서의 수신지 MAC 주소 / 무선 구간에서의 송신지 MAC 주소 / 액세스 포인트의 MAC 주소
- 제어 프레임의 MAC 주소
  - 제어 프레임에 설정된 MAC 주소 필드의 수는 프레임 용도에 따라 달라짐

#### 시퀀스 제어

- 4비트의 프래그먼트 신호와 12비트의 시퀀스 신호로 구성된 필드로 프래그멘테이션된 프레임을 재결합하거나 중복된 프레임을 파기할 때 사용함
- 무선 LAN은 ACK 프레임으로 확인, 응답 하면서 통신을 진행하는데 무선 LAN 단말은 액세스 포인트로부터 ACK 프레임이 도착하지 않으면
일정 시간 동안 기다린 뒤 재전송함
- 이때 시퀀스 제어에 앞에서 송신한 프레임에 설정한 것과 같은 값을 설정
- 액세스 포인트는 그 값을 보고 중복 프레임인지 판단

### 무선 LAN 단말이 접속되기까지

- 무선 LAN은 누구나 전파를 수신할 수 있는 공공 공간을 사용해 통신하기 때문에 보안에 신경 쓰며 접속하도록 되어 있음
- 어소시에이션 -> 인증 -> 공유키 생성 -> 암호화 통신 4단계를 거쳐 통신함

#### 어소시에이션 단계

- 어떤 액세스 포인트와 접속할지 결정하는 단계
- 스캔 -> 인증 -> 어소시에이션 3단계로 구성
- 스캔
  - 액세스 포인트와 무선 LAN 단말이 서로의 존재를 인식하는 단계
- 인증
  - 오픈 시스템 인증
    - 인증 처리를 하지 않음
    - 모든 인증 요청에 대해 인증을 허가
    - WEP 암호화와 같은 방식
  - 공유키 인증
    - 인증 구조가 매우 단순하기 때문에 손쉽게 공유키가 해독되어 버림
  - WEP를 사용하지 않고 인증은 일단 오픈 시스템 인증으로 통과시킨 뒤 실제 인증은 어소시에이션 뒤의 인증 단계에서 수행함
- 어소시에이션
  - 최종 확인 단계

#### SSID

- 무선 LAN을 식별하기 위한 문자열(이름)

#### 인증 단계

- 무선 LAN 인증 방식 2가지
  - 퍼스널 모드
    - 비밀번호로 인증하는 방식
    - 가정의 와이파이
    - 무선 LAN 단말과 액세스 포인트의 어소시에이션이 완료되면 비밀번호로부터 마스터키라 부르는 공유키의 소재를 생성
    - 비밀번호가 유출되면 누구나 접속할 수 있어 위험성이 높음
  - 엔터프라이즈 모드
    - 디지털 인증서나 ID/비밀번호, SIM 카드 등을 이용해 인증하는 방식
    - 인증 서버에서 일괄적 인증이 가능하기에 기업에서 많이 씀
    - 안전하지만 별도로 운용 관리에 비용이 듬

#### 공유키 생성 단계

- 인증 단계에서 생성한 마스터키로부터 실제 암/복호화에 사용하는 공유키를 생성하는 단계
- 4웨이 핸드셰이크 교환 과정을 통해 서로 유니캐스트용 공유키와 멀티캐스트용 공유키를 생성하여 공유함

#### 암호화 통신 단계

- 공유키가 만들어졌다면 실제 암호화 통신을 시작함
- 무선 LAN에서 사용하는 암호화 방식 WEP, WPA, WPA2, WPA3
- 순서대로 보안 레벨이 높아짐
- WEP(Wired Equivalent Privacy)
  - 초기 무선 LAN에서 사용된 암호화 방식
  - 같은 공유키를 계속해서 사용하고 암호화 알고리즘에 취약성이 발견되었기 때문에 현재 거의 사용하지 않음
- WPA(Wi-Fi Protected Access)
  - WEP를 개량해 취약성을 낮추는 것을 목적으로 한 암호화 방식
  - 공유키를 일정 간격으로 변경하지만 WEP를 기반의 취약성이 발견되어 잘 사용하지 않음
- WPA2
  - 암호화 알고리즘으로 AES를 사용함
  - 해독하는 방법이 아직 발견되지 않았으며 가장 많이 사용하는 암호화 방식
- WPA3
  - WPA2를 개량한 암호화방식

### 무선 LAN의 형태

- 액세스 포인트 운용 관리 형태에 따라 크게 분산 관리형, 집중 관리형, 클라우드 관리형의 3가지 종류로 나눔

#### 분산 관리형

- 액세스 포인트를 1대씩 설정하고 각각 운용, 관리하는 형태
- 가정이나 소규모 사무실의 무선 LAN 환경에서 일반적 사용
- 비용을 줄이지만 액세스 포인트 대수가 늘어날수록 운용 관리가 어려워짐

#### 집중 관리형

- 무선 LAN 컨트롤러라는 서버를 사용해 많은 액세스 포인트를 운용 관리하는 형태
- 중간 규모에서 대규모 사무실의 무선 LAN 환경에서 일반적으로 사용
- 초기 비용과 성능 한계가 있음
- 1대의 무선 LAN 컨트롤러로 관리할 수 있는 액세스 포인트 수에 한계가 있으며 그 한계를 초과했을 때는 새로운 컨트롤러를 사야함

#### 클라우드 관리형

- 집중 관리형이 진화된 것으로 무선 LAN 컨트롤러의 기능을 클라우드에서 갖도록 클라우드 컨트롤러에서 액세스 포인트를 관리하는 형태
- 운영 비용이 듬

### 무선 LAN과 관련된 다양한 기능

#### 게스트 네트워크

- 방문자에게 제공되는 무선 LAN 환경
- 인터넷에는 접속할 수 있지만 가정의 네트워크에는 접속할 수 없는 SSID 네트워크를 만들 수 있음
- 많은 가정용 와이파이 라우터에서도 제공할 만큼 일반적인 기능이 됨

#### MAC 주소 필터링

- 단말의 MAC 주소를 기반으로 필터링하는 기능
- WPA2와 함께 사용해 보안 수준을 더욱 향상하고자 할 때 사용
- MAC 주소를 위장했을 때 대응할 수 없을 뿐만 아니라 단말 수가 많아졌을 때 운용 관리가 복잡해짐

#### 웹 인증

- 웹브라우저에서 사용자 이름과 비밀번호를 입력해 인증하는 방식
- 호텔, 역, 게스트 네트워크 와이파이등에서 자주 사용됨
- 무선 LAN 단말이 대상 SSID에 접속하면 웹브라우저가 실행되고 로그인 페이지로 이동

#### 밴드 스티어링

- 2.4GHz 대역과 5GHz 대역 양쪽에 대응하는 무선 LAN 단말을 5GHz로 유도하는 기능
- 2.4는 주파수 간섭이 발생하기 쉬운 경향이 있기 때문

----------------------

## ARP

- MAC 주소는 NIC 자체에 내장되어 있는 물리적 주소
  - 데이터링크 계층에서 동작함
- IP 주소는 OS상에서 설정한 논리적 주소
  - 네트워크 계층에서 동작함
- 두 가지 주소를 접속해 데이터링크 계층과 네트워크 계층의 다리 역할을 하는 프로토콜이 ARP(Address Resolution Protocol)
- 어떤 단말이 데이터를 송신할 때 네트워크 계층에서 받아들인 IP 패킷을 이더넷 프레임으로 캡슐화하여 케이블로 보내야 함
  - IP 패킷을 받아들이는 것만으로는 이더넷 프레임을 만들수 없음  
  - 수신지 MAC 주소를 알아야 함
- 실제 데이터 통신에 앞서 ARP에서 수신지 IP주소로부터 수신지 MAC 주소를 구함
  - 이것을 주소 결정(Address Resolution)이라 부름

### ARP의 프레임 포맷

#### 하드웨어 타입

- 사용하는 L2 프로토콜을 의미하는 2바이트 필드
  - 이더넷에서는 '0x0001'

#### 프로토콜 타입

- 사용하는 L3 프로토콜을 의미하는 2바이트 필드
  - IPv4에서는 '0x0800'

#### 하드웨어 주소 크기

- MAC 주소의 길이를 바이트 단위로 나타내는 1바이트 필드
- MAC 주소는 48비트 = 6바이트이므로 6이 들어감

#### 프로토콜 주소 크기

- 네트워크 계층에서 사용하는 주소(IP) 길이를 바이트 단위로 나타냄
- IPv4의 길이는 32비트 = 4바이트이므로 4가 들어감

#### 오퍼레이션 코드

- ARP 프레임의 종류를 나타내는 2바이트 필드

#### 송신지MAC 주소/송신지 IPv4 주소

#### 목표 MAC 주소/목표 IPv4 주소

- 최초에는 MAC 주소를 모르므로 더미 MAC 주소인 '00:00:00:00:00:00' 설정

### ARP에 의한 주소 결정 흐름

- ~님 계십니까? 네 있습니다 방식
- 계십니까라고 묻는 패킷을 ARP Request
  - 같은 네트워크에 있는 단말 모두에게 브로드캐스트로 패킷을 송신
- 네 있습니다라고 대답하는 패킷을 ARP Reply
  - 1:1 유니캐스트로 송신됨

#### 구체적인 주소 결정 예시

- PC1이 같은 이더넷 네트워크에 존재하는 PC2의 MAC 주소를 결정하는 상황 가정

1. PC1은 네트워크 계층에서 전달받은 IP 패킷에 포함된 IPv4주소를 보고 자신의 ARP 테이블을 검색. ARP 테이블은 ARP에서 주소를 결정한 정보를
일정 시간 저장하는 메모리상의 테이블. 정보가 없다면 진행, 있다면 2~5 처리를 뛰어넘어 6을 수행
2. PC1은 ARP Request를 송신하기 위해 ARP 필드 정보를 조합함. 오퍼레이션 코드는 ARP Request를 나타내는 1
3. ARP Request가 같은 이더넷 네트워크에 있는 단말 모두에게 전달됨. 주소 결정 대상인 PC2는 자신에 대한 ARP 프레임이라고 판단하고 해당 요청을 받아들임
다른 이더넷 네트워크에 있는 PC3에게는 ARP 프레임이 도달하지 않음
4. PC2는 ARP Reply를 응답하기 위해 ARP 필드 정보를 조합함. 오퍼레이션 코드는 ARP Reply를 나타내는 2
5. PC1은 ARP Reply의 ARP 필드에 포함된 송신지 MAC 주소와 송신지 IPv4주소를 보고 PC2의 MAC 주소를 인식함
6. 통신을 시작함

### ARP 캐시 기능

- ARP에는 치명적 약점이 있는데 바로 브로드캐스트를 전제로 한다는 점
- ARP는 주소 결정한 내용을 일정 시간 저장하는 캐시 기능 제공

### GARP를 이용한 기능

- ARP외에도 주소 결정을 효율적으로 구현하기 위한 특별한 ARP GARP
- GARP는 ARP 필드의 목표 IPv4주소에 자신의 IPv4를 설정한 특별한 ARP

--------------

## 기타 L2 프로토콜

### PPP

- Point to Point Protocol는 이름 그대로 포인트와 포인트를 1:1로 접속하기 위한 L2 프로토콜
  - 전화선을 그대로 사용해 인터넷에 접속하는 등에 사용

#### PAP

- Password Authentication Protocol는 PPP 클라이언트가 사용자 ID와 비밀번호를 송신하고
서버가 미리 설정해 둔 사용자 ID와 비밀번호를 기반으로 인증
- 거의 사용되지 않으며 CHAP 로 대체됨

#### CHAP

- Challenge Handshake Authentication Protocol

### PPPoE

- Point to Point Protocol over Ethernet
- 다이얼업 접속에 사용되던 PPP를 이더넷 네트워크상에서도 사용할 수 있도록 확장한 프로토콜

### IPoE

- Internet Protocol over Ethernet

### PPTP

- Point to Point Tunneling Protocol
- 이더넷상에 가상 전용선을 만드는 VPN 프로토콜

### L2TP

- Layer2 Tunneling Protocol
- 인터넷에 가상 전용선을 만드는 프로토콜
