# 아키텍처 요소 테스트하기

- 헥사고날 아키텍처에서의 테스트 전략

-------------

## 테스트 피라미드

- 기본 전제는 만드는 비용이 적고, 유지보수하기 쉽고, 빨리 실행되고, 안정적인 작은 크기의 테스트들에 대해 높은
커버리지를 유지해야 한다는 것
  - 하나의 단위(하나의 클래스, 메서드)가 제대로 동작하는지 확인할 수 있는 단위 테스트들
- 여러 개의 단위와 단위를 넘는 경계, 아키텍처 경계, 시스템 경계를 결합하는 테스트는 만드는 비용이 더 비싸지고, 실행이 더 느려지며
깨지기 더 쉬워짐.
- 테스트 피라미드는 테스트가 비싸질수록 테스트의 커버리지 목표는 낮게 잡아야 한다는 것을 보여줌
  - 그렇지 않으면 새로운 기능을 만드는 것보다 테스트를 만드는 데 시간을 더 쓰게 됨
- 단위 테스트는 피라미드의 토대에 해당함
  - 일반적으로 하나의 클래스를 인스턴스화하고 해당 클래스의 인터페이스를 통해 기능들을 테스트함
  - 테스트 중인 클래스가 다른 클래스에 의존한다면 의존되는 클래스들은 인스턴스화하지 않고 흉내 내는 목(mock)으로 대체
- 피라미드의 다음 계층은 통합 테스트
  - 연결된 여러 유닛을 인스턴스화하고 시작점이 되는 클래스의 인터페이스로 데이터를 보낸 후 유닛들의 네트워크가 기대한대로 잘 동작하는지 검증
- 시스템 테스트는 애플리케이션을 구성하는 모든 객체 네트워크를 가동시켜 특정 유스케이스가 전 계층에서 잘 동작하는지 검증
  - 시스템 테스트 위에는 UI를 포함하는 엔드투엔드 테스트 층이 있을 수 있음 

--------------

## 단위 테스트로 도메인 엔티티 테스트하기

- 단위 테스트가 도메인 엔티티에 녹아 있는 비즈니스 규칙을 검증하기에 가장 적절한 방법이다.
  - 만들고 이해하는 것도 쉽고, 빠르게 실행됨
  - 도메인 엔티티의 행동은 다른 클래스에 거의 의존하지 않기 때문에 다른 종류의 테스트는 필요치 않음

------------

## 단위 테스트로 유스케이스 테스트하기

- 테스트 중인 유스케이스 서비스는 상태가 없기(stateless) 때문에 'then' 섹션에서 특정 상태를 검증할 수 없다.
- 대신 테스트는 서비스가 의존 대상의 특정 메서드와 상호작용했는지 여부를 검증한다
  - 코드의 행동 변경뿐만 아니라 코드의 구조 변경에도 취약해진다는 의미
  - 코드가 리팩터링되면 테스트도 변경될 확률이 높아짐
- 테스트에서 어떤 상호작용을 검증하고 싶은지 신중하게 생각해야 한다.
  - 모든 동작을 검증하는 대신 중요한 핵심만 골라 집중해서 테스트하는것
  - 모든 동작을 검증하려면 클래스가 조금이라도 바뀔 때마다 테스트를 변경해야하고, 이는 테스트의 가치를 떨어트림

---------------

## 통합 테스트로 웹 어댑터 테스트하기

- 웹 어댑터는 JSON 문자열 등의 형태로 HTTP를 통해 입력을 받고, 입력에 대한 유효성 검증을 하고, 유스케이스에서
사용할 수 있는 포맷으로 매핑하고 유스케이스에 전달한다.
- 유스케이스의 결과를 JSON으로 매핑하소 HTTP 응답을 통해 클라이언트에 반환한다.

------------

## 얼마만큼의 테스트가 충분할까?

- 라인 커버리지는 테스트 성공을 측정하는 데 있어서는 잘못된 지표다.
- 테스트를 실행한 후에 소프트웨어를 배포해도 될 만큼 테스트를 신뢰한다면 그것으로 됬다.
- 헥사고날 아키텍처에서 사용하는 전략
  - 도메인 엔티티를 구현할 때는 단위 테스트로 커버하자
  - 유스케이스를 구현할 때는 단위 테스트로 커버하자
  - 어댑터를 구현할 때는 통합 테스트로 커버하자
  - 사용자가 취할 수 있는 중요 애플리케이션 경로는 시스템 테스트로 커버하자

----------

## 유지보수가 가능한 소프트웨어를 만드는 데 어떻게 도움이 될까?

- 헥사고날 아키텍처는 도메인 로직과 바깥으로 향한 어댑터를 깔끔하게 분리한다.
  - 도메인 로직은 단위 테스트
  - 어댑터는 통합 테스트
- 입출력 포트는 테스트에서 아주 뚜렷한 모킹 지점이 된다.
- 모킹하는 것이 너무 버거워지거나 코드의 특정 부분을 커버하기 위해 어떤 종류의 테스트를 써야 할지 모르겠다면 이는 경고 신호다.
