# 아키텍처 개요

--------------------

## 네 개의 영역

- 표현, 응용, 도메인, 인프라스트럭처는 아키텍처를 설계할 때 출현하는 전형적인 네 가지 영역이다.
- 표현 영역은 사용자의 요청을 받아 응용 영역에 전달하고 응용 영역의 처리 결과를 다시 사용자에게 보여주는 역할을 한다.
  - 스프링 MVC 프레임워크가 표현 영역을 위한 기술에 해당한다.
- 응용 영역은 시스템이 사용자에게 제공해야 할 기능을 구현한다.
  - 응용 영역은 기능을 구현하기 위해 도메인 영역의 도메인 모델을 사용한다.
  - 응용 서비스는 로직을 직접 수행하기보다는 도메인 모델에 로직 수행을 위임한다.
- 도메인 영역은 도메인 모델을 구현한다.
  - 도메인 모델은 도메인의 핵심 로직을 구현한다.
- 인프라스트럭처 영역은 구현 기술에 대한 것을 다룬다.
  - RDBMS 연동을 처리하고 메시징 큐에 메시지를 전송하거나 수신하는 기능을 구현하고, 데이터 연동을 하며
  SMTP를 이용한 메일 발송 기능을 구현하거나 HTTP 클라이언트를 이용해서 REST API를 호출하는 것도 처리한다.
  - 논리적인 개념을 표현하기 보다는 실제 구현을 다룬다.

---------------------

## 계층 구조 아키텍처

- 계층 구조는 그 특성상 상위 계층에서 하위 계층으로의 의존만 존재하고 하위 계층은 상위 계층에 의존하지 않는다.
- 표현 계층은 응용 계층에 의존, 응용 계층은 도메인 계층에 의존한다.
- 계층 구조를 엄격하게 적용한다면 상위 계층은 바로 아래의 계층에만 의존을 가져야하지만 구현의 편리함을 위해 계층 구조를 유연하게 적용하기도 한다.
- 하지만 그럴 경우 테스트하기 어렵고 너무 의존적이라 유지보수의 어려움이라는 문제가 발생한다.

---------------------

## DIP

- 고수준 모듈은 의미 있는 단일 기능을 제공하는 모듈이다.(가격 할인 계산)
- 고수준 모듈의 기능을 구현하려면 여러 하위 기능이 필요한데, 이 하위 기능을 실제로 구현한 것이 저수준 모듈이다.(가격 할인 계산 기능을
구현하려면 고객 정보를 구해야하고 룰을 실행)
- 고수준 모듈이 제대로 동작하려면 저수준 모듈을 사용해야 한다. 그런데 고수준 모듈이 저수준 모듈을 사용하면 구현 변경과 테스트가 어렵다는 문제가 발생한다.
- DIP는 이 문제를 해결하기 위해 저수준 모듈이 고수준 모듈에 의존하도록 바꾼다.
- 저수준 모듈이 고수준 모듈을 의존하도록 바꾸려면 추상화한 인터페이스를 사용하면 된다.
- 구현 기술 교체 문제에서 고수준 모듈은 저수준 모듈에 의존하지 않고 구현을 추상화한 인터페이스에 의존하며, 실제 사용할 저수준 구현 객체는
의존 주입을 이용해서 전달받을 수 있다.
- 구현 기술을 변경하더라도 고수준 모듈을 변경할 필요없이 저수준 구현 객체를 생성하는 코드만 변경하면 된다.

### DIP 주의 상항

- DIP를 잘못 생각하면 단순히 인터페이스와 구현 클래스를 분리하는 정도로 받아들일 수 있는데 DIP의 핵심은
고수준 모듈이 저수준 모듈에 의존하지 않도록 하기 위함이다. 즉 결과 구조만 보고 저수준 모듈에서 인터페이스를 추출해선 안된다.

### DIP와 아키텍처

- DIP를 적용하면 인프라스트럭처 영역이 응용 영역과 도메인 영역에 의존하는 구조가 된다.
- DIP를 항상 적용할 필요는 없다. 사용하는 구현 기술에 따라 완벽한 DIP를 적용하기 보다는 구현 기술에 의존적인 코드를 도메인에 일부 포함하는게
효과적일 때도 있다. DIP의 이점을 얻는 수준에서 적용 범위를 검토해야 한다.

------------------------

## 도메인 영역의 주요 구성요소

- 도메인 영역은 도메인의 핵심 모델을 구현한다.
- 도메인 영역의 모델은 도메인의 주요 개념을 표현하며 핵심 로직을 구현한다.
- 도메인 영역의 주요 구성요소
  - 엔티티(Entity)
    - 교유의 식별자를 갖는 객체로 자신의 라이프 사이클을 갖는다.
    - 주문, 회원, 상품과 같이 도메인의 고유한 개념을 표현한다.
    - 도메인 모델의 데이터를 포함하며 해당 데이터와 관련된 기능을 함께 제공한다.
  - 밸류(Value)
    - 고유의 식별자를 갖지 않는 객체로 주로 개념적으로 하나인 값을 표현할 때 사용된다.
    - 배송지 주소를 표현하기 위한 주소, 구매 금액을 위함 금액과 같은 타입이 밸류 타입이다.
    - 엔티티의 속성으로 사용할 뿐만 아니라 다른 밸류 타입의 속성으로도 사용할 수 있다.
  - 애그리거트(Aggregate)
    - 연관된 엔티티와 밸류 객체를 개념적으로 하나로 묶은 것이다.
    - 주문과 관련된 Order 엔티티, OrderLine 밸류, Orderer 밸류 객체를 '주문' 애그리거트로 묶을 수 있다.
  - 리포지터리(Repository)
    - 도메인 모델의 영속성을 처리한다.
    - DBMS 테이블에서 엔티티 객체를 로딩하거나 저장하는 기능을 제공한다.
  - 도메인 서비스(Domain Service)
    - 특정 엔티티에 속하지 않은 도메인 로직을 제공한다.
    - 할인 금액 계산은 상품, 쿠폰, 회원 등급, 구매 금액 등 다양한 조건을 이용해서 구현하게 되는데 이렇게 도메인 로직이
    여러 엔티티와 밸류를 필요로 한다면 도메인 서비스에서 로직을 구현한다.

### 엔티티와 밸류

- DB 테이블의 엔티티와 도메인 모델의 엔티티의 가장 큰 차이점은 도메인 모델의 엔티티는 데이터와 함께 도메인 기능을 함께 제공한다는 점이다.
  - 주문을 표현하는 엔티티는 주문과 관련된 데이터뿐만 아니라 배송지 주소 변경을 위한 기능을 함께 제공
- 도메인 모델의 엔티티는 단순히 데이터를 담고 있는 데이터 구조라기 보다는 데이터와 함께 기능을 제공하는 객체이다.
- 도메인 관점에서 기능을 구현하고 기능 구현을 캡슐화해서 데이터가 임의로 변경되는 것을 막는다.
- 또 다른 차이점은 도메인 모델의 엔티티는 두 개 이상의 데이터가 개념적으로 하나인 경우 밸류 타입을 이용해서 표현할 수 있다는 것이다.

### 애그리거트

- 도메인 모델이 복잡해지면 개발자가 전체 구조가 아닌 한 개 엔티티와 밸류에만 집중하는 상황이 발생한다.
- 이때 상위 수준에서 모델을 관리하지 않고 개별 요소에만 초점을 맞추다 보면, 큰 수준에서 모델을 이해하지 못해 큰 틀에서 모델을 관리할 수 없는 상황에 빠질
수 있다.
- 매우 상세하게 나온 대축척 지도를 보면 큰 수준에서 어디에 위치하고 있는지 이해하기 어려우므로 큰 수준에서 보여주는 소축적 지도를 함께 봐야 현재 위치를
보다 정확하게 이해할 수 있는 것 처럼 도메인 모델도 개별 객체뿐만 아니라 상위 수준에서 모델을 볼 수 있어야 전체 모델의 관계와 개별 모델을 이해하는 데 도움이 된다.
- 도메인 모델에서 전체 구조를 이해하는 데 도움이 되는 것이 바로 애그리거트이다.
- 애그리거트는 관련 객체를 하나로 묶은 군집(주문: 주문, 배송지 정보, 주문자, 주문 목록, 총 결제 금액)
- 애그리거트를 사용하면 개별 객체가 아닌 관련 객체를 묶어서 객체 군집 단위로 모델을 바라볼 수 있게 된다.
- 애그리거트는 군집에 속한 객체를 관리하는 루트 엔티티를 갖는다.

### 리포지터리

- 도메인 객체를 지속적으로 사용하려면 물리적인 저장소에 도메인 객체를 보관해야 하는데 이를 위한 도메인 모델이 리포지터리이다.
- 엔티티나 밸류가 요구사항에서 도출되는 도메인 모델이라면 리포지터리는 구현을 위한 도메인 모델이다.

-----------------------

## 요청 처리 흐름

- 사용자가 어플리케이션에 기능 실행을 요청하면 그 요청을 처음 받는 영역은 표현 영역이다.
- 표현 영역은 사용자가 전송한 데이터 형식이 올바른지 검사하고 문제가 없다면 응용 서비스에 기능 실행을 위임한다.
  - 이때 표현 영역은 사용자가 전송한 데이터를 응용 서비스가 요구하는 형식으로 변환해서 전달한다.
  - HTTP 요청 파라미터를 응용 서비스가 필요로 하는 데이터로 변환해서 응용 서비스를 실행할 때 인자로 전달.
- 응용 서비스는 도메인 모델을 이요해서 기능을 구현한다.
  - 기능 구현에 필요한 도메인 객체를 리포지터리에서 가져오 ㅏ실행하거나 신규 도메인 객체를 생성해서 리포지터리에 저장한다.

--------------------

## 인프라스트럭처 개요

- 인프라스트럭처는 표현 영역, 응용 영역, 도메인 영역을 지원한다.
- 도메인 영역과 응용 영역에서 인프라스트럭처의 기능을 직접 사용하는 것보다 이 두 영역에 정의한 인터페이스를 인프라스트럭처 영역에서
구현하는 것이 시스템을 더 유연하고 테스트하기 쉽게 만들어준다.

----------------

## 모듈 구성

- 아키텍처의 각 영역은 별도 패키지에 위치한다.
- 도메인이 크면 하위 도메인으로 나누고 각 하위 도메인마다 별도 패키지를 구성한다.
- 도메인 모듈은 도메인에 속한 애그리거트를 기준으로 다시 패키지를 구성한다.
