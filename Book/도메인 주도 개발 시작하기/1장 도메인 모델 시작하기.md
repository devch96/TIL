# 도메인 모델 시작하기

-------------

## 도메인이란?

- 온라인 서점을 예로 들 때 책을 검색하고, 장바구니에 담아두기도 하고, 구매하고, 쿠폰을 찾아보기도 하며, 간편 결제 서비스나
외부 포인트를 이용하여 결제하고, 구매한 뒤 배송 추적 기능도 사용한다.
- 개발자 입장에서 바라보면 온라인 서점은 구현해야 할 소프트웨어의 대상이 된다.
- 도메인이란 소프트웨어로 해결하고자 하는 문제 영역이다. 즉 온라인 서점은 도메인이다.
- 한 도메인은 다시 하위 도메인으로 나눌 수 있다.(회원, 혜택, 결제, 주문 ...)
- 한 하위 도메인은 다른 하위 도메인과 연동하여 완전한 기능을 제공한다.
- 특정 도메인을 위한 소프트웨어라고 해서 도메인이 제공해야 할 모든 기능을 직접 구현하는 것이 아니고, 외부 시스템을 사용하고 연동한다.
- 도메인마다 고정된 하위 도메인이 존재하는 것은 아니다.

------------------

## 도메인 전문가와 개발자 간 지식 공유

- 도메인 전문가 즉 유통, 정산, 홍보 등의 전문가들은 해당 도메인에 대한 지식과 경험을 바탕으로 본인들이 원하는 기능 개발을 요구한다.
- 개발자는 이런 요구사항을 분석하고 설계하여 코드를 작성하며 테스트하고 배포한다.
- 이 과정에서 요구사항은 첫 단추와 같다. 첫 단추를 잘못 끼우면 모든 단추가 잘못 끼워지듯이 요구사항을 올바르게 이해하지 못하면
요구하지 않은 엉뚱한 기능을 만들게 된다.
- 요구사항을 올바르게 이해하려면 여러 방법이 있지만 비교적 간단한 방법은 개발자와 전문가가 직접 대화하는 것이다.
- 개발자와 전문가 사이에 내용을 전파하는 전달자가 많으면 많을수록 정보가 왜곡되고 손실이 발생하게 되며, 개발자는 최초에 전문가가 요구한 것과는
다른 무언가를 만들게 된다.
- 도메인 전문가 만큼은 아니겠지만 이해관계자와 개발자도 도메인 지식을 어느정도는 갖춰야 한다.

---------------------

## 도메인 모델

- 도메인 모델은 특정 도메인을 개념적으로 표현한 것이다.
- 도메인을 이해하려면 도메인이 제공하는 기능과 도메인의 주요 데이터 구성을 파악해야 하는데, 이런 면에서 기능과 데이터를 함께 보여주는
객체 모델은 도메인을 모델링하기에 적합하다.
- 도메인 모델을 객체로만 모델링할 수 있는 것이 아니고 상태 다이어그램과 같은 UML 표기법도 사용할 수 있다.
- 사실 어떠한 방식으로든 도메인을 이해하는 데 도움이 된다면 표현 방식이 무엇인지는 중요하지 않다.
- 도메인 모델은 기본적으로 도메인 자체를 이해하기 위한 개념 모델이기 때문에 구현 기술에 맞는 구현 모델이 따로 필요하다.
- 구현 모델이 개념 모델을 최대한 따르도록 해야 한다.
- 도메인에 따라 용어 의미가 결정되므로(카탈로그 도메인의 상품: 상품 가격, 상세 내용 등을 표현, 배송 도메인의 상품: 실제 배송되는 물리적인 상품)
여러 하위 도메인을 하나의 다이어그램에 모델링하면 안 된다.
- 모델의 각 구성요소는 특정 도메인으로 한정할 때 비로소 의미가 완전해지기 때문에 각 하위 도메인마다 별도로 모델을 만들어야 한다.

--------------------

## 도메인 모델 패턴

- 사용자 인터페이스(UI) 또는 표현(Presentation)
  - 사용자의 요청을 처리하고 사용자에게 정보를 보여준다.
  - 여기서 사용자는 소프트웨어를 이용하는 사람 뿐 아니라 외부 시스템도 포함한다.
- 응용(Application)
  - 사용자가 요청한 기능을 실행한다.
  - 업무 로직을 직접 구현하지 않으며 도메인 계층을 조합해서 기능을 실행한다.
- 도메인
  - 시스템이 제공할 도메인 규칙을 구현한다.
- 인프라스트럭처(Infrastructure)
  - 데이터베이스나 메시징 시스템과 같은 외부 시스템과의 연동을 처리한다.
- 도메인 계층은 도메인의 핵심 규칙을 구현한다.
- 도메인 모델이란 용어는 도메인 자체를 표현하는 개념적인 모델을 의미하지만, 도메인 계층을 구현할 때 사용하는 객체 모델을
언급할 때에도 도메인 모델이라는 용어를 사용한다.

---------------------

## 도메인 모델 도출

- 기획서, 유스케이스, 사용자 스토리와 같은 요구사항과 관련자와의 대화를 통해 도메인을 이해하고 이를 바탕으로 도메인 모델 초안을 만들어야
비로소 코드를 작성할 수 있다.
- 도메인을 모델링할 때 기본이 되는 작업은 모델을 구성하는 핵심 구성요소, 규칙, 기능을 찾는 것이다.

-----------------------

## 엔티티와 밸류

- 도출한 모델은 크게 엔티티(Entity)와 밸류(Value)로 구분할 수 있다.

### 엔티티

- 엔티티의 가장 큰 특징은 식별자를 가진다는 것이다.
- 식별자는 엔티티 객체마다 고유해서 각 엔티티는 서로 다른 식별자를 갖는다.
- 엔티티의 식별자는 바뀌지 않고 고유하기 때문에 두 엔티티 객체의 식별자가 같으면 두 엔티티는 같다고 판단할 수 있다.

### 엔티티의 식별자 생성

- 엔티티의 식별자를 생성하는 시점은 도메인의 특징과 사용하는 기술에 따라 달라진다.
  - 특정 규칙에 따라 생성
    - 주문번호, 운송장번호, 카드번호와 같은 식별자는 특정 규칙에 따라 생성한다.
    - 흔히 사용하는 규칙은 현재 시간과 다른 값을 함께 조합하는 것이다.
  - UUID나 Nano ID와 같은 고유 식별자 생성기 사용
    - 다수의 개발 언어가 UUID 생성기를 제공하고 있으므로 마땅한 규칙이 없다면 UUID를 식별자로 사용해도 된다.
  - 값을 직접 입력
    - 회원의 아이디나 이메일과 같은 식별자는 값을 직접 입력하는데, 직접 입력하는 값이기 때문에 식별자를 중복해서 입력하지 않도록
    사전에 방지하는 것이 중요하다.
  - 일련번호 사용(시퀀스나 DB의 자동 증가 칼럼 사용)
    - 자동 증가 칼럼은 DB 테이블에 데이터를 삽입해야 비로소 값을 알 수 있기 때문에 테이블에 데이터를 추가하기 전에는 식별자를 알 수 없다.
    - 이것은 엔티티 객체를 생성할 때 식별자 값을 전달할 수 없음을 의미한다.

### 밸류 타입

```java
public class ShippingInfo{
    private String receiverName;
    private String receiverPhoneNumber;
    
    private String shippingAddress1;
    private String shippingAddress2;
    private String shippingZipcode;
}
```

- receiverName 필드와 receiverPhoneNumber 필드는 서로 다른 데이터를 담고 있지만 두 필드는 개념적으로 받는 사람을 의미한다.
- shippingAddress1,2 필드와 shippingZipcode 필드는 각기 다른 데이터를 담고 있지만 주소라는 하나의 개념을 표현한다.
- 밸류 타입은 개념적으로 완전한 하나를 표현할 때 사용한다.

```java
public class Receiver{
    private String name;
    private String phoneNumber;
}

public class Address{
    private String address1;
    private String address2;
    private String zipcode;
}

public class ShippingInfo{
    private Receiver receiver;
    private Address address;
}
```

- 밸류 타입이 꼭 두개 이상의 데이터를 가져야 하는 것은 아니며 의미를 명확하게 표현하기 위해 밸류 타입을 사용하는 경우도 있다.
```java
public class OrderLine{
    private Product product;
    private Money price;
    private int quantity;
    private Money amounts;
}

public class Money{
    private int value;
}
```
- int 타입으로 price와 amounts를 표현해도 되지만 Money 타입 덕에 price나 amounts가 금액을 의미한다는 것을 쉽게 알 수 있다.
- 밸류 타입의 또 다른 장점은 밸류 타입을 위한 기능을 추가할 수 있다는 것이다.(Money 타입은 돈 계산을 위한 기능을 추가할 수 있다.)
```java
public class Money{
    private int value;
    
    public Money add(Money money){
        return new Money(this.value + money.value);
    }
}
```
- 밸류 객체의 데이터를 변경할 때는 기존 데이터를 변경하기보다는 변경한 데이터를 갖는 새로운 밸류 객체를 생성하는 방식을 선호한다.
- 데이터 변경 기능을 제공하지 않는 타입을 불변(immutable)타입이라 하는데 불변 타입으로 구현하는 가장 중요한 이유는 안전한 코드를 작성할 수 있다는 데 있다.
- 만약 밸류 타입이 불변이 아닐 경우 밸류 타입을 사용하는 클래스에서 방어적 복사를 해야한다.

### 엔티티 식별자와 밸류 타입

- 엔티티 식별자의 실제 데이터는 String과 같은 문자열로 구성된 경우가 많다.
  - 신용카드 번호, 이메일 주소 등
- 식별자는 단순한 문자열이 아니라 도메인에서 특별한 의미를 지니는 경우가 많기 때문에 식별자를 위한 밸류 타입을 사용해서 의미가 잘 드러나도록 할 수 있다.

### 도메인 모델에 set 메서드 넣지 않기

- 도메인 모델에 get/set 메서드를 무조건 추가하는 것은 좋지 않은 버릇이다. 특히 set 메서드는 도메인의 핵심 개념이나 의도를 코드에서 사라지게 한다.
- set 메서드를 넣을 경우 단순히 상태 값만 변경하는 것이기 때문에 로직을 사용하는지 안하는지 알 수 없고 필드값만 변경하고 끝나기 때문에
상태 변경과 관련된 도메인 지식이 코드에서 사라진다.
- set 메서드의 또 다른 문제는 도메인 객체를 생성할 때 온전하지 않은 상태가 될 수 있다.
- 도메인 객체가 불완전한 상태로 사용되는 것을 막으려면 생성 시점에 필요한 것을 전달해 주어야 한다. 즉 생성자를 통해 필요한 데이터를 모두 받아야 한다.
- 생성자로 필요한 것을 모두 받으므로 다음처럼 생성자를 호출하는 시점에 필요한 데이터가 올바른지 검사할 수 있다.

-------------------------------

## 도메인 용어와 유비쿼터스 언어

-  코드를 작성할 때 도메인에서 사용하는 용어는 매우 중요하다.
- 도메인에서 사용하는 용어를 코드에 반영하지 않으면 그 코드는 개발자에게 코드의 의미를 해석해야 하는 부담을 준다.
- 유비쿼터스 언어란 도메인 주도 설계에서 언어의 중요함을 강조하기 위해 에릭 에반스가 사용한 용어로 전문가, 관계자, 개발자가 도메인과 관련된 공통의
언어를 만들고 이를 대화, 문서, 도메인 모델, 코드, 테스트 등 모든 곳에서 같은 용어를 사용하는 것이다.
- 도메인 용어는 좋은 코드를 만드는 데 매우 중요한 요소임에 틀림없지만 영어이기 때문에 국내 개발자는 불리한 점이 있다.
- 도메인에서 사용하는 용어의 의미를 명확하게 전달하는 영단어를 찾기 힘든 경우도 있고, 반대로 비슷한 의미의 영단어가 많으면 각 단어의 뉘앙스나 미세한 차이를 몰라서
선택하기 어려울 때도 있다.
  - '상태'를 코드로 표현할 때 state와 status중 어떤 단어를 사용?
  - '종류'를 표현하기 위해 'kind'와'type'중 어떤 단어가 맞나?
- 알맞은 영단어를 찾는 것은 쉽지 않은 일이지만 시간을 들여 찾는 노력을 해야 한다.
