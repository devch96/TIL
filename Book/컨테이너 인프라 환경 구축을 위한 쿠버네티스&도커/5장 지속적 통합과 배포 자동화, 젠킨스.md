# 지속적 통합과 배포 자동화, 젠킨스

- 컨테이너로 구동하는 어플리케이션은 어떻게 배포하는 것이 가장 좋을까?

1. 깃허브 등의 저장소에 저장해 둔 어플리케이션 소스 코드를 내려받아 도커 컨테이너 이미지로 빌드.
2. 빌드한 컨테이너 이미지를 쿠버네티스에서 사용할 수 있도록 레지스트리에 등록.
3. 레지스트리에 등록된 이미지를 기반으로 쿠버네티스 오브젝트 생성.
4. 생성한 오브젝트를 외부에서 접속할 수 있도록 서비스 형태로 노출

## 컨테이너 인프라 환경에서 CI/CD

- CI는 코드를 커밋하고 빌드했을 때 정상적으로 작동하는지 반복적으로 검증해 어플리케이션의 신뢰성을 높이는 작업.
- CI 과정을 마친 어플리케이션은 신뢰할 수 있는 상태가 됨.
- CD는 CI 과정에서 생성된 신뢰할 수 있는 어플리케이션을 실제 상요 환경에 자동으로 배포하는 것을 의미.
- 어플리케이션을 상용 환경에 배포할 때 고려해야 할 사항이 여러 가지 있는데, 
이를 CD에 미리 정의하면 실수를 줄이고, 실제 적용 시간도 최소화할 수 있음.

### CI/CD 도구 비교

- 팀시티(Teamcity)
  - 젯브레인즈(Jetbrains)에서 만든 도구
  - 빌드 작업을 수행하는 에이전트 3개와 빌드 작업 100개를 무료로 사용 가능. 그 이상은 유료
- 깃허브 액션(Github Action)
  - 깃허브에서 지원하는 워크플로(workflow) 기반의 CI/CD 도구
  - 깃허브에 저장한 소스 코드를 자동 분석한 결과를 기반으로 깃허브 액션이 추천하는 방식에 따라 워크플로를 구성하거나
  사용자가 직접 워크플로를 정하는 파일을 장성한 후 깃허브 저장소에 넣어 사용할 수 있음.
  - 깃허브 저장소에 소스 코드를 공개할 경우 깃허브 액션을 무료로 사용할 수 있음, 프라이빗은 한 달에 2000분 제한 시간. 추가는 유료
- 뱀부(Bamboo)
  - 아틀라시안(Atlassian)에서 만든 CI/CD 도구로 유료이며 사용자의 서버에 설치해 사용.
- 젠킨스(Jenkins)
  - 오픈 소스 CI/CD 도구
  - 사용자가 직접 UI에서 작업을 구성하거나 작업 순서를 코드로 정의할 수 있음.

### 젠킨스로 쿠버네티스 운영 환경 개선하기

- 어플리케이션 배포 영역에 쿠버네티스를 사용하면 개발자는 개발에만 집중할 수 있음.
- 모든 배포 환경을 컨테이너 인프라로 일원화하고, CI/CD 도구를 사용하면 어플리케이션에 맞는 환경을 적용해 자동으로 배포.

## 젠킨스 설치를 위한 간편화 도구 살펴보기

- 쿠버네티스 클러스터 환경에서는 배포 도구들이 많이 준비돼있다.

### 배포 간편화 도구 비교하기

- kubectl은 바이너리 실행 파일로 짜인 배포 도구이다.
- kubectl이 없다면 직접 코드를 짜서 API 서버에 명령을 내려야 한다.
- 큐브시티엘(kubectl)
  - 쿠버네티스에 기본으로 포함된 커맨드라인 도구로 추가 설치 없이 바로 사용할 수 있음.
  - 큐브시티엘은 정의된 매니페스트 파일을 그대로 배포하기 때문에 개별적인 오브젝트를 관리하거나 배포할 때 사용하는 것이 좋음.
- 커스터마이즈(kustomize)
  - 오브젝트를 사용자의 의도에 따라 유동적으로 배포할 수 있음.
  - 별도의 커스터마이즈 실행 파일을 활용해 커스터마이즈 명세를 따르는 yaml파일을 생성할 수 있음.
  - 운영 중인 환경에서 배포 시 가변적인 요소를 적용하는 데 적합함.
- 헬름(Helm)
  - 가장 널리 알려진 도구. 
  - 오브젝트 배포에 필요한 사양이 이미 정의된 차트(Chart)라는 패키지를 활용
  - 헬름 차트 저장소가 온라인에 있기 때문에 패키지를 검색하고 내려받아 사용하기가 매우 간편.

### 커스터마이즈로 배포 간편화하기

- 커스터마이즈를 통한 배포는 kubectl에 구성돼 있는 매니페스트를 고정적으로 이용해야 하는 기존 방식을 유연하게 만듬.

#### 커스터마이즈의 작동 원리

- 커스터마이즈는 yaml 파일에 정의된 값을 사용자가 원하는 값으로 변경 가능.
- 쿠버네티스에서 오브젝트에 대한 수정 사항을 반영하려면 사용자가 직접 에디터로 수정해야 하는데 파일이 많거나 하나의 파일로
여러 클러스터에 배포해야해서 LABEL, NAME 같은 일부 항목을 수정해야 한다면 시간이 많이 듬.
- 커스터마이즈는 이를 위해 kustomize 명령을 제공.

### 헬름으로 배포 간편화하기

- 헬름을 통한 배포는 커스터마이즈에서 제한적이었던 주소 할당 영역과 같은 값을 대체하면서 간단하게 설치할 수 있도록
설계돼 있다.

#### 헬름의 작동 원리

- 헬름은 쿠버네티스에 패키지를 손쉽게 배포할 수 있도록 패지키를 관리하는 쿠버네티스 전용 패키지 매니저
- 컨테이너 인프라 환경에서 어플리케이션을 배포하려면 ConfigMap, ServiceAccount, PV, PVC, Secret 등
어플리케이션 배포 구성에 필요한 모든 쿠버네티스 오브젝트를 작성하고 kubectl 명령을 실행해서 쿠버네티스 클러스터에 설치해야 한다.
- 이럴 때 헬름을 사용하면 요구 조건별로 리소스를 편집하거나 변수를 넘겨서 처리하는 패키지를 만들 수 있다.

#### 헬름으로 MetalLB 한 번에 만들기

1. 헬름 설치
2. 헬름 차트 등록 주소 확인
3. 저장소를 등록해 설치할 준비
   - helm repo add edu http://iac-source.github.io/helm-charts
4. 헬름 차트 저장소 확인
   - helm repo list
5. 헬름으로 차트 저장소를 추가한 시점의 차트를 로컬 캐시에 저장해 install과 같은 작업 수행 시에 먼저 로컬에 있는 캐시 차트 정보를 참조함.
저장소 추가 이후에 변경된 차느가 있다면 변경된 정보를 캐시에 업데이트해야함.
   - helm repo update
6. 저장소 edu로부터 MetalLB 설치
   - helm install metallb edu/metallb --namespace=metallb-system --create-namespace --set controller.tag=v0.8.3
    --set speaker.tag=v0.8.3 --set configmap.ipRange=192.168.1.11-192.168.1.29
   - --namespace: 헬름 차트를 통해서 생성되는 어플리케이션이 위치할 네임스페이스를 지정.
   - --create-namespace: 네임스페이스 옵션으로 지정된 네임스페이스가 존재하지 않을 경우 네임스페이스 생성.
   - --set: 헬름에서 사용할 변수를 명령 인자로 전달.
7. 배포 상태 확인
   - kubectl get pods -n metallb-system
8. MetalLB 태그 확인
   - kubectl describe pods -n metallb-system | grep Image:

## 젠킨스 설치 및 설정하기

### 헬름으로 젠킨스 설치하기

1. 젠킨스로 지속적 통합을 진행하는 과정에서 컨테이너 이미지를 레지스트리에 푸시하는 단계가 있음. 레지스트리 부터 구성해야 함.
2. 헬름으로 설치되는 젠킨스는 파드에서 동작하는 어플리케이션이기 때문에 PV를 마운트하지 않으면 파드가 다시 시작될 때 내부 볼륨 데이터가 삭제됨.
PV가 NFS를 통해 프로비저닝될 수 있게 NFS를 설치해야 함.
3. PV에 접근 ID를 부여하지 않으면 PVC를 사용해 파일을 읽고 쓰는 기능에 문제가 발생할 수 있음.
   - chown 1000:1000 /nfs_shared/jenkins/ (젠킨스 컨트롤러 이미지에서 기본적으로 사용 하는 유저ID와 그룹 ID가 1000번)
4. 젠킨스는 사용자가 배포를 위해 생성한 내용과 사용자의 계정 정보, 사용하는 플러그인과 같은 데이터를 저장하기 위해 PV와 PVC의 구성을 필요로 함.
5. 젠킨스 설치

### 젠킨스 살펴보기

#### 젠킨스 접속하기

- kubectl get services 의 LoadBalancer 타입의 외부 IP 로 접속.
- 메인 화면 좌측 메뉴
  - 새로운 Item: 젠킨스를 통해서 빌드할 작업을 아이템(Item)이라고 함.
  - 사람: 사용자를 관리하는 메뉴. 사용자의 정보를 관리하는 데는 젠킨스를 구동하는 서버에서 직접 사용자를 관리하는 방법과
  젠킨스가 별도의 DB를 가지고 자체적으로 사용자를 관리하는 방법이 있음.
  - 빌드 기록: 젠킨스 작업에 대한 성공, 실패, 진행 내역을 볼 수 있음.
  - Jenkins 관리: 젠킨스의 시스템, 보안, 도구, 플러그인 등 각종 설정을 수행하는 곳.
    - 시스템 설정: 메인 화면에 표시될 문구, 동시에 실행할 수 있는 실행기 개수, 젠킨스를 접속할 수 있는 경로, 관리자의 정보
    시스템 전체에 적용할 환경변수 등 이곳에서 설정.
    - Global Tool Configuration: 빌드 과정에서 사용하는 도구(Maven, JDK, Git, Docker 등)의 경로 및 옵션을 설정할 수 있음.
    - 플러그인 관리: 젠킨스에서 사용할 플러그인을 설치, 삭제, 업데이트.
    - 노드 관리: 젠킨스에서 사용하는 노드를 추가, 삭제하거나 노드의 세부 설정 및 상태 모니터링을 할 수 있는 메뉴.
    - Configuration as Code: 젠킨스의 설정을 내보내거나 불러올 수 있다.
    - Manage Credentials: 젠킨스에 사용하는 플러그인에 필요한 접근 키, 비밀 키, API 토근과 같은 접속에 필요한 인증 정보 관리.
  - My Views: 젠킨스에서 각종 작업을 분류해 모아서 볼 수 있는 대시보드.
  - Lockable Resources: 젠킨스에서 작업이 끝날 때까지 같은 작업을 하지 못하게 하는 잠금 장치를 설정할 수 있음.
  - New View: 대시보드인 View를 생성하는 작업.

### 젠킨스 컨트롤러 설정하기

- 젠킨스를 사용하기 위해서는 기본적을 컨트롤러와 에이전트 구동과 관련한 여러 설정이 필요.

#### 젠킨스 시스템 설정하기

- Jenkins 관리 > 시스템 설정
- 시스템 메시지: 젠킨스 메인 웹 페이지에서 접속했을 때 나타나는 메시지를 입력.
- of executors: 동시에 빌드를 수행할 수 있는 실행기의 개수를 설정하는 옵션.
- Label: 노드를 구분할 수 있는 레이블을 지정.
- Usage: 젠킨스의 빌드 작업에 대해 젠킨스 노드가 어떻게 처리할지 설정.
- Quiet period: 빌드 작업이 시작될 때까지 잠시 대기하는 시간을 설정하는 값.
- SCM checkout retry count: 소스 코드 저장소(SCM)으로 부터 파일을 가져오지 못한 경우 몇 번 재시도 할지.
- Restrict project naming: 젠킨스를 통해 만들어지는 작업 이름 규칙
- Jenkins URL: 설치된 젠킨스 컨트롤러의 접속 주소
- Resource Root URL: 빌드 결과물과 같은 내용을 외부에 공개하기 위해 사용되는 주소로 Jenkins URL과 다름.

#### 젠킨스 플러그인 관리하기

- 젠킨스는 실행되는 모든 기능을 플러그인으로 구현하도록 설계돼있음.
- Jenkins 관리 > 플러그인 관리
- 업데이트된 플러그인 목록: 젠킨스에 설치된 플러그인 중에 업데이트된 플러그인이 있는 경우 최신 버전으로 올릴 수 있음.
- 설치 가능: 설치되지 않은 플러그인을 검색해 현재 젠킨스에서 해당 기능을 추가할 수 있음.
- 고급: 외부와 연결되는 프록시 서버 설정을 할 수 있음.

### 젠킨스 에이전트 설정하기

#### 젠킨스 노드 관리

- Jenkins 관리 > 노드 관리
- 신규 노드: 에이전트 노드를 추가한다. 고정된 여러 대의 서버에서 에이전트 노드를 추가해야 할 때 필요하다.
- Configure Clouds: 클라우드 환경 기반의 에이전트를 설정할 때 필요하다.
- Node Monitoring: 에이전트 노드의 안정성을 위한 각종 모니터링과 관련된 사항을 설정할 수 있다.
- 노드 목록: 현재 구성된 노드의 목록을 보여준다.

#### jenkins 서비스 어카운트를 위한 권한 설정하기

- 젠킨스 에이전트 파드에서 쿠버네티스 API 서버로 통신하려면 서비스 어카운트에 권한을 줘야 함.
  - kubectl create clusterrolebinding jenkins-cluster-admin --clusterrole=cluster-admin --serviceaccount=default:jenkinds

## 젠킨스로 CI/CD 구현하기

- 새로운 Item 클릭해 새로운 아이템 만들기.
- 아이템이란?
  - 새롭게 정의할 작업.
  - CI/CD를 하려면 각각의 작업은 모두 정의가 필요.
  - 작업을 코드로 정의한 경우라고 해도 작업 순서 정도는 알려줘야 함.

### Freestyle project로 실습

1. 이름 dpy-fs-dir-prod로 지정하고 Freestyle project 아이템 생성
2. General 탭에서 Restrict where this project can be run 체크 해제(젠킨스의 에이전트가 특정한 레이블을 가지고 있을 때 해당 레이블을 가진 
에이전트에서만 실행될 수 있도록 제한을 가하는 옵션)
3. 소스 코드 관리 탭에서 젠킨스 외부에 있는 소스 코드 저장소를 젠킨스 CI로 사용하도록 지정.(github repo url, branch)
4. Build 단계 추가. 실제로 젠킨스가 작업을 수행할 방법을 선택하는 단계.
5. 젠킨스에서 빌드에 사용할 명령어를 확인하고 입력
   - 명령어:
     - 도커 이미지 빌드 > 도커 이미지 푸시 > 디플로이먼트 생성 > 로드밸런서를 통한 노출
6. Build Now 실행

