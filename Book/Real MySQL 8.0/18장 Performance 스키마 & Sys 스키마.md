# Performance 스키마 & Sys 스키마

- DB를 사용하면 대표적인 문제 중 하나가 성능 이슈다.
  - 서비스 초창기엔 트래픽이 없기 때문에 아무런 문제가 없어 보임
  - 서비스가 성장하면서 데이터가 커지고 트래픽이 늘어나면 최적화되지 않은 설정이나 쿼리 등으로 인해
  성능 문제가 나타날 가능성이 높음.
- 사용 중인 DB의 성능을 기존보다 향상시켜야 하는 상황에 놓이면 가장 먼저 해야 할 일은 현재 DB가 어떤 상태인지 분석하고
성능을 향상시킬 수 있는 튜닝 요소를 찾는 것.
- MySQL에서는 사용자가 DB 상태 분석을 좀 더 수월하게 할 수 있게 내부에서 발생하는 이벤트에 대한 상세한 정보를 수집해서
한 곳에 모아 확인할 수 있는 기능을 제공
  - Performance 스키마와 Sys 스키마

------------

## Performance 스키마란?

- MySQL 서버가 기본적으로 제공하는 시스템 데이터베이스 중 하나로, MySQL 서버의 데이터베이스 목록에서 performance_schema라는 이름의
데이터베이스로 확인할 수 있다.
- MySQL 서버 내부 동작 및 쿼리 처리와 관련된 세부 정보들이 저장되는 테이블들이 존재
  - 서버의 성능을 분석하고 내부 처리 과정 등을 모니터링할 수 있음.
- Performance 스키마에 저장되는 데이터들은 서버 소스코드 곳곳에 존재하는 성능 측정 코드로부터 수집되며, 이는 Performance 스키마를 위해
별도로 구현된 전용 스토리지 엔진인 PERFORMANCE_SCHEMA 스토리지 엔진에 의해 수행된다.
- PERFORMANCE_SCHEMA 스토리지 엔진은 서버가 동작 중인 상태에서 실시간으로 정보를 수집하며, 수집한 정보를 디스크가 아닌 메모리에 저장한다.
  - 활성화하면 CPU와 메모리 등의 서버 리소스를 좀 더 소모한다.
  - 수집 가능한 전체 데이터가 아닌 특정 이벤트에 대한 데이터들만 수집하도록 설정할 수 있으므로 오버헤드를 줄일 수 있다.
- Performance 스키마에 존재하는 테이블들은 디스크에 테이블 구조만 저장돼 있고, 실제 데이터는 모두 메모리상에서 관리되므로 서버가 재시작하면 해당
데이터는 모두 초기화되어 복구할 수 없다.
- Performance 스키마에서 발생하는 데이터 변경은 바이너리 로그에 기록되지 않기 때문에 레플리카 서버로 복제되지 않는다.

----------

## Performance 스키마 구성

### Setup 테이블

- Performance 스키마의 데이터 수집 및 저장과 관련된 설정 정보가 저장돼 있음.
- 이 테이블을 통해 스키마의 설정을 동적으로 변경할 수 있음.
  - setup_actors
    - 모니터링하며 데이터를 수집할 대상 유저 목록
  - setup_consumers
    - 얼마나 상세한 수준으로 데이터를 수집하고 저장할 것인지를 결정하는 저장 레벨 설정
  - setup_instruments
    - 데이터를 수집할 수 있는 MySQL 내부 객체들의 클래스 목록과 클래스별 데이터 수집 여부 설정
  - setup_objects
    - 모니터링하며 데이터를 수집할 대상 데이터베이스 객체(프로시저, 테이블, 트리거 등)
  - setup_threads
    - 모니터링하며 데이터를 수집할 수 있는 MySQL 내부 스레드들의 목록과 스레드별 데이터 수집 여부 설정

### Instance 테이블

- Performance 스키마가 데이터를 수집하는 대상인 실체화된 객체들, 인스턴스들에 대한 정보를 제공하며 종류별로 테이블이 구분돼 있음
  - cond_instances
    - 서버에서 동작 중인 스레드들이 대기하는 조건(Condition) 인스턴스들의 목록을 확인할 수 있음.
    - 기다리고 있는 조건이 참이 되면 작업을 재개
  - file_instances
    - 서버가 열어서 사용 중인 파일들의 목록을 확인할 수 있음.
    - 파일이 삭제되면 테이블에서도 데이터가 삭제
  - mutex_instances
    - 서버에서 사용 중인 뮤텍스 인스턴스들의 목록을 확인할 수 있음.
  - rwlock_instances
    - 서버에서 사용 중인 읽기 및 쓰기 잠금 인스턴스들의 목록을 확인할 수 있음.
  - socket_instances
    - 서버가 클라이언트의 요청을 대기하고 있는 소켓 인스턴스들의 목록을 확인할 수 있음.

### Connection 테이블

- MySQL에서 생성된 커넥션들에 대한 통계 및 속성 정보를 제공한다.
  - account
    - DB 계정명과 MySQL 서버로 연결한 클라이언트 호스트 단위의 커넥션 통계 정보 확인 가능
  - hosts
    - 호스트별 커넥션 통계 정보 확인 가능
  - users
    - DB 계정명별 커넥션 통계 정보 확인 가능
  - session_account_connect_attrs
    - 현재 세션 및 현재 세션에서 MySQL에 접속하기 위해 사용한 DB 계정과 동일한 계정으로 접속한 다른 세션들의 커넥션 속성 정보 확인 가능
  - session_connect_attrs
    - 연결된 전체 세션들의 커넥션 속성 정보 확인 가능

### Variable 테이블

- 서버의 시스템 변수 및 사용자 정의 변수와 상태 변수들에 대한 정보 제공
  - global_variables
    - 전역 시스템 변수 정보
  - session_variables
    - 현재 세션에 대한 세션 범위의 시스템 변수들에 정보
    - 현재 세션에서 설정한 값들을 확인할 수 있음
  - variables_by_thread
    - 현재 MySQL에 연결돼 있는 전체 세션에 대한 세션 범위의 시스템 변수들의 정보가 저장돼 있다.
  - persisted_variables
    - SET PERSIST 또는 SET PERSIST_ONLY 구문을 통해 영구적으로 설정된 시스템 변수에 대한 정보가 저장돼 있다.
  - variables_info
    - 전체 시스템 변수에 대해 설정 가능한 값 범위 및 가장 최근에 변수의 값을 변경한 계정 정보 등이 저장돼 있다.
  - user_variables_by_thread
    - 현재 MySQL에 연결돼 있는 세션들에서 생성한 사용자 정의 변수들에 대한 정보가 저장돼 있다.
  - global_status
    - 전역 상태 변수들에 대한 정보가 저장돼 있다.
  - session_status
    - 현재 세션에 대한 세션 범위의 상태 변수들의 정보가 저장돼 있다.
  - status_by_thread
    - 현재 MySQL에 연결돼 있는 전체 세션들에 대한 세션 범위의 상태 변수들의 정보가 저장돼 있으며 세션별로 구분될 수 있는 상태 변수만 저장된다.

### Event 테이블

- Wait Event 테이블
  - 각 스레드에서 대기하고 있는 이벤트들에 대한 정보를 확인할 수 있다.
- Stage Event 테이블
  - 각 스레드에서 실행한 쿼리들의 처리 단계에 대한 정보를 확인할 수 있다.
  - 쿼리가 구문 분석, 테이블 열기, 정렬 등과 같은 쿼리 처리 단계 중 현재 어느 단계를 수행하고 있는지와 처리 단계별 소요 시간 등을
  알 수 있다.
- Statement Event 테이블
  - 각 스레드가 실행한 쿼리들에 대한 정보를 확인할 수 있다.
- Transaction Event 테이블
  - 각 스레드에서 실행한 트랜잭션에 대한 정보를 확인할 수 있다.
  - 트랜잭션별로 트랜잭션 종류와 현재 상태, 격리 수준 등을 알 수 있다.

### Summary 테이블

- Performance 스키마가 수집한 이벤트들을 특정 기준별로 집계한 후 요약한 정보를 제공한다.

### Lock 테이블

- MySQL에서 발생한 잠금과 관련된 정보를 제공한다.

### Replication 테이블

- SHOW [REPLICA | SLAVE] STATUS 명령문에서 제공하는 것보다 더 상세한 복제 관련 정보를 제공한다.

--------------

## Performance 스키마 설정

- 5.6.6 버전부터 MySQL 구동 시 기본으로 기능이 활성화되도록 설정이 변경됐다.
- 명시적으로 기능의 활성화 여부를 제어하고 싶은 경우에는 MySQL 설정 파일에 performance_schema=OFF/ON 옵션을 추가하면 된다.
  - SHOW GLOBAL VARIABLES 명령을 통해 MySQL에서 Performance 스키마가 활성화돼 있는지 확인할 수 있다.

### 메모리 사용량 설정

- Performance 스키마의 데이터는 메모리에 저장하므로 메모리 사용량 설정은 데이터를 얼마나 저장할 것인지를 설정하는 것이다.

### 데이터 수집 및 저장 설정

- Performance 스키마가 어떤 대상에 대해 모니터링하며 어떤 이벤트들에 대한 데이터를 수집하고 또 수집한 데이터를 어느 정도 수준으로
저장하게 할 것인지를 제어할 수 있다.

#### 런타임 설정 적용

- setup_이라는 접두사로 시작하는 테이블들이 설정 테이블이다.

--------------

## Sys 스키마

- Performance 스키마는 다양한 정보를 제공하지만 사용하기 어렵다
  - 테이블이 많고 복잡함
- Sys 스키마는 이 같ㅇ은 불편한 사용성을 보완하고자 도입됐다.
  - 5.7.7 버전부터는 기본 내장, 이전에는 깃헙에서 다운받아 설치

---------

## Sys 스키마 사용을 위한 사전 설정

- Performance 스키마 기능이 활성화돼 있어야 한다.
- 사용자가 root와 같이 MySQL에 해 전체 권한을 가진 DB 계정으로 접속한 경우 Sys 스키마에서 제공하는 모든 데이터베이스 객체를 자유롭게 사용할 수 있으나
제한적인 권한을 가진 DB 계정에서는 Sys 스키마를 사용하기 위해 추가 권한이 필요할 수 있다.

---------------

## Sys 스키마 구성

- 테이블
  - 일반 테이블로는 Sys 스키마의 데이터베이스 객체에서 사용되는 옵션의 정보가 저장돼 있는 테이블 하나만 존재.
  - InnoDB 스토리지 엔진으로 영구적으로 보존
  - sys_config
- 뷰
  - Formatted-View
    - 출력되는 결과에서 시간이나 용량과 같은 값들을 사람이 쉽게 읽을 수 있는 수치로 변환해서 보여주는 뷰
  - Raw-View
    - 데이터를 저장된 원본 형태 그대로 출력해서 보여줌
- 스토어드 프로시저
  - Sys 스키마에서 제공하는 스토어드 프로시저를 사용해 Performance 스키마의 설정을 손쉽게 확인 및 변경할 수 있으며,
  MySQL 서버 상태와 현재 실행 중인 쿼리들에 대해 종합적으로 분석한 보고서 형태의 데이터도 확인할 수 있음.
- 함수
  - Sys 스키마에서는 값의 단위를 변환하고, Performance 스키마의 설정 및 데이터를 조회하는 등의 다양한 기능ㅇ르 가진 함수들을 제공
