# InnoDB 클러스터

- 소스-레플리카 구조의 복제 형태로 구성해놓는다고 해서 고가용성이 실현되는 것은 아니다.
  - 소스 서버에서 장애가 발생했을 때 레플리카 서버가 자동으로 기존 소스 서버를 대체하는 새로운 소스 서버로
  전환되는 것은 아니기 때문
- MySQL 서버는 자체적으로 페일오버(Failover)를 처리하는 기능을 제공하지 않으므로 사용자는 장애가 발생했을 때 레플리카 서버가
새로운 소스 서버가 될 수 있도록 일련의 작업들을 수행해야 한다.
  - 레플리카 서버에 설정된 읽기 모드 해제
  - 스플릿 브레인 현상을 방지하기 위해 장애가 발생한 소스 서버에서 데이터 변경을 실행하지 못하도록 함
  - 애플리케이션 서버는 새로운 소스 서버를 바라보도록 커넥션 설정
- 대부분의 이와 같은 전환 작업을 계속 수동으로 처리하기 보다는 자동화하는 것을 고려함
  - 서버 장애를 감지해 자동으로 페일오버를 처리하는 프로그램을 직접 개발 혹은 외부 솔루션 사용
    - MMM, MHA, Orchestrator

----------

## InnoDB 클러스터 아키텍처

- InnoDB 클러스터는 단순하게 MySQL 서버 내에서 설정할 수 있는 어떤 특정한 기능이 아닌 MySQL의 고가용성 실현을 위해 만들어진 여러 구성 요소들의
집합체다.
- InnoDB 클러스터 구성 요소
  - 그룹 복제
    - 소스 서버의 데이터를 레플리카 서버로 동기화하는 기본적인 복제 역할뿐만 아니라 복제에 참여하는 MySQL 서버들에 대한 자동화된 멤버십 관리
      (그룹에 새로운 멤버 추가 및 제거 등) 역할을 담당한다.
  - MySQL 라우터
    - 애플리케이션 서버와 MySQL 서버 사이에서 동작하는 미들웨어 프로그램.
    - 애플리케이션이 실행한 쿼리를 적절한 MySQL 서버로 전달하는 프록시 역할
  - MySQL 쉘
    - 기존 MySQL 클라이언트보다 좀 더 확장된 기능을 가진 새로운 클라이언트 프로그램
    - SQL문 실행뿐만 아니라 자바스크립트 및 파이썬 기반의 스크립트 작성 기능과 MySQL 서버에 대해 클러스터 구성 등의 어드민 작업을 할 수 있게 하는
    API 제공
- InnoDB 클러스터에서는 MySQL 서버에 장애가 발생하면 그룹 복제가 먼저 이를 감지해서 자동으로 해당 서버를 복제 그룹에서 제외시키며,
MySQL 라우터는 이러한 복제 토폴로지 변경을 인지하고 자신이 가진 메타데이터를 갱신해서 클라이언트로부터 실행된 쿼리가 현재 복제 그룹에서 정상적으로 동작하는
MySQL 서버로만 전달될 수 있도록 한다.

---------------

## 그룹 복제

- 그룹 복제는 5.7.17 버전에서 도입된 새로운 복제 방식이며, 기존 MySQL 복제 프레임워크를 기반으로 구현되어 내부적으로 Row 포맷의 바이너리 로그와 릴레이 로그,
GTID를 사용한다.
- 기존 복제의 경우 일반적으로 소스-레플리카 형태로 구성되어 단방향으로만 복제가 이뤄지는 반면, 그룹 복제에서는 복제에 참여하는 MySQL 서버들이 하나의 복제 그룹으로
묶인 클러스터 형태를 가지며 그룹 내 서버들은 서로 통신하면서 양방향으로도 복제 처리를 할 수 있다.

### 그룹 복제 아키텍처

- 그룹 복제에 참여하는 MySQL 서버들은 그룹 복제 플러그인을 통해 서로 간에 지속적으로 통신하며 복제 동기화를 처리한다.
- 그룹 복제 플러그인은 MySQL 서버에 그룹 복제가 설정되면 group_replication_applier라는 복제 채널을 생성하며 이 채널을 통해 그룹에서 실행된
모든 트랜잭션을 전달받아 적용하게 된다.
- 서버가 그룹에 새로 가입해서 이미 그룹에 참여하고 있는 서버들과 같이 그룹의 최신 데이터를 가지도록 하는 그룹 복제 분산 복구 작업이 필요한 경우
group_replication_recovery라는 복제 채널을 생성해서 분산 복구 작업을 진행한다.

-----------

## MySQL 셸

- MySQL을 위한 고급 클라이언트 툴로, 단순히 SQL문 실행만 가능했던 mysql보다 좀 더 확장된 기능을 사용자에게 제공한다.
  - 자바스크립트, 파이썬 언어 모드

----------

## MySQL 라우터

- 애플리케이션 서버로부터 유입된 쿼리 요청을 클러스터 내 적절한 MySQL 서버로 전달하고 MySQL 서버에서 반환된 쿼리 결과를 다시 애플리케이션 서버로
전달하는 프록시 역할을 수행한다.
- 주요 기능
  - InnoDB 클러스터의 MySQL 구성 변경 자동 감지
  - 쿼리 부하 분산
  - 자동 페일오버

-----------

## InnoDB 클러스터 구축

- InnoDB 클러스터를 구축하는 것이 복잡해 보일 수 있지만 실제로는 자동화된 기능들을 통해 손쉽게 구축할 수 있다.

### InnoDB 클러스터 요구사항

- InnoDB 클러스터는 그룹 복제를 사용하므로 구성될 서버들은 기본적으로 그룹 복제에서 요구하는 사항들을 충족해야 하며,
그 외에 추가로 다음 요구사항들에 대해서도 충족돼야 한다.
- InnoDB 클러스터 구성 요소 버전
  - MySQL 서버 5.7.17 이상
  - MySQL 셸 1.0.8 이상
  - MySQL 라우터 2.1.2 이상
- InnoDB 클러스터의 MySQL 서버들은 모두 Performance 스키마가 활성화돼 있어야 한다.
- MySQL 셸을 사용해 InnoDB 클러스터를 구성하기 위해 MySQL 셸이 설치될 서버에 파이썬이 2.7 이상의 버전으로 설치돼 있어야 한다.

### InnoDB 클러스터 생성

#### 사전 준비

- InnoDB 클러스터에 사용될 MySQL 서버들은 InnoDB 클러스터 요구사항을 충족하도록 서버 옵션들이 적절하게 설정돼 있어야 하며, 클러스터 관리를 위한
DB 계정도 서버에 준비돼 있어야 한다.
  - 전부 수동으로 설정할 수도 있지만 셸을 통해 간단하고 편리하게 설정 작업을 진행할 수 있다.
