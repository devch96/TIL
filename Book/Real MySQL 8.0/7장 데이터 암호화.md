# 데이터 암호화

- MySQL 5.7 버전부터 지원하기 시작한 데이터 암호화 기능은 데이터 파일(테이블 스페이스)에 대해서만 암호화 기능이
제공됐다.
- MySQL 8.0으로 업그레이드되면서 데이터 파일뿐만 아니라 리두 로그나 언두 로그, 복제를 위한 바이너리 로그 등도 모두 암호화 기능을
지우너하기 시작했다.
- 데이터 암호화 여부는 보안 감사에서 필수적으로 언급되는 부분이며, 핀테크 서비스처럼 중요한 정보를 저장하는 서비스에서는 응용 프로그램에서 암호화한
데이터를 데이터베이스 서버에서 다시 암호화하는 이중 암호화 방법을 선택하기도 한다.
  - 응용 프로그램의 암호화는 주로 중요 정보를 가진 칼럼 단위로 암호화를 수행하며, 데이터베이스 수준에서는 테이블 단위로 암호화를 적용한다.

---------------

## MySQL 서버의 데이터 암호화

- MySQL 서버의 암호화 기능은 데이터베이스 서버와 디스크 사이의 데이터 읽고 쓰기 지점에서 암복호화를 수행한다.
  - MySQL 서버(InnoDB 스토리지 엔진)의 I/O 레이어에서만 데이터의 암호화 및 복호화 과정이 실행된다.
- MySQL 서버에서는 사용자의 쿼리를 처리하는 과정에서 테이블의 데이터가 암호화돼 있는지 여부를 식별할 필요가 없으며, 암호화된 테이블도
그렇지 않은 테이블과 동일한 처리 과정을 거친다.
- 암호화 기능이 있든 없든 MySQL 내부와 사용자 입장에선 아무런 차이가 없다
  - 이러한 암호화 방식을 가리켜 TDE(Transparent Data Encryption)이라고 한다.

### 2단계 키 관리

- MySQL 서버의 TDE에서 암호화 키는 키링(KeyRing) 플러그인에 의해 관리된다.
  - keyring_file
    - File-Based 플러그인
  - keyring_encrypted_file
    - Keyring 플러그인
  - keyring_okv
    - KMIP 플러그인
  - keyring_aws
    - Amazon Web Services Keyring 플러그인
- keyring_file 플러그인만 커뮤니티 에디션에서 사용 가능하고 나머지는 엔터프라이즈 에디션에서 사용 가능하다.
- MySQL 서버의 데이터 암호화는 마스터 키와 테이블스페이스 키라는 두 가지 종류의 키를 가지고 있다.
- MySQL 서버는 HashiCorp Vault 같은 외부 키 관리 솔루션 또는 디스크의 파일에서 마스터 키를 가져오고, 암호화된 테이블이 생성될 때마다
해당 테이블을 위한 임의의 테이블스페이스 키를 발급한다.
- MySQL 서버는 마스터 키를 이용해 테이블스페이스키를 암호화해서 각 테이블의 데이터 파일 헤더에 저장한다.
  - 테이블스페이스키는 테이블이 삭제되지 않는 한 절대 변경되지 않는다.
  - 절대 노출되지 않기 때문에 변경하지 않아도 안전하다.
- 마스터 키는 노출될 수 있기 때문에 주기적으로 변경해야 한다
```mysql
ALTER INSTANCE ROTATE INNODB MASTER KEY;
```

### 암호화와 성능

- 디스크로부터 한 번 읽은 데이터 페이지는 복호화되어 InnoDB의 버퍼 풀에 적재되는데, 메모리에 적재되면 암호화되지 않은 테이블과 동일한 성능을 보인다.
- 하지만 존재하지 않는 데이터 페이지를 읽어야 하는 경우에는 복호화 과정을 거치기 때문에 쿼리 처리가 지연된다.
- 암호화된 테이블이 변경되면 디스크로 동기화될 때 암호화해야 하기 때문에 시간이 더 걸린다.
- 데이터 페이지 저장은 사용자의 쿼리를 처리하는 스레드가 아닌 백그라운드 스레드가 수행하기 때문에 사용자 쿼리가 지연되는 것은 아니다.
- TDE를 적용한다고 해도 데이터 파일의 크기는 동일한 크기를 가지기 때문에 암호화한다고 InnoDB 버퍼 풀의 효율이 달라지거나 메모리 사용 효율이 떨어지는 현상은
발생하지 않는다.
- 같은 테이블에 대해 암호화와 압축이 동시 적용되면 압축을 먼저하고 암호화한다.

-----------------

## 테이블 암호화

### 테이블 생성

```mysql
CREATE TABLE tab_encrypted(
    id INT PRIMARY KEY
) ENCRYPTION='Y';
```

### 응용 프로그램 암호화와의 비교

- 응용 프로그램에서 직접 암호화해서 MySQL 서버에 저장하는 경우도 있는데, 이 경우 저장되는 칼럼의 값이 이미 암호화된 것인지
여부를 MySQL 서버는 인지하지 못하기 때문에 인덱스를 생성하더라도 인덱스의 기능을 100% 활용할 수 없다.
- 응용 프로그램의 암호화 기능은 서비스의 요건과 성능을 고려해서 선택해야 하고, MySQL 서버의 암호화 기능과 혼합해서 사용한다면 더 안전한 서비스를
구축할 수 있을 것이다.

### 테이블스페이스 이동

- 테이블을 다른 서버로 복사해야 하는 경우 또는 특정 테이블의 데이터 파일만 백업했다가 복구하는 경우라면 테이블스페이스 이동(export import)기능이
레코드를 덤프했다가 복구하는 방식보다 훨씬 효육적이고 빠르다.
- TDE가 적용되어 암호화된 테이블의 경우 원본 서버와 목적지 서버의 마스터 키가 다르기 때문에 신경 써야 할 부분이 있다.
```mysql
FLUSH TABLES source_table FOR EXPORT ;
```
- 이 명령이 실행되면 MySQL 서버는 source_table의 저장되지 않은 변경 사항을 모두 디스크로 기록하고 잠금을 건다.
- 그와 동시에 source_table의 구조를 source_table.cfg 파일로 기록한다.
- source_table.ibd 파일과 source_table.cfg 파일을 목적지 서버로 복사한다.
- 복사가 모두 완료되면 UNLOCK TABLES 명령을 실행해 source_table을 사용할 수 있게 하면 된다.
- TDE로 암호화된 테이블에 위 명령을 실행하면 임시로 사용할 마스터 키를 발급해서 source_table.cfp라는 파일로 기록한다.
- 암호화된 테이블의 테이블스페이스 키를 기존 마스터 키로 복호화한 후, 임시로 발급한 마스터 키를 이용해 다시 암호화해서 데이터 파일의 헤더 부분에 저장한다.
- 암호화된 테이블의 경우 반드시 데이터 파일과 임시 마스터 키가 저장된 cfp 파일을 함께 복사해야 한다.
- cfp 파일이 없어지면 복구가 불가능해진다.

------------

## 언두 로그 및 리두 로그 암호화

- 테이블에 암호화를 적용하더라도 메모리에 존재하는 데이터는 복호화된 평문으로 관리된다.
  - 이 평문 데이터가 테이블의 데이터 파일 이외의 디스크 파일로 기록되는 경우에 평문으로 저장된다.
- MySQL 8.0.16 버전부터는 innodb_undo_log_encrypt, innodb_redo_log_encrypt 시스템 변수를 이용해 암호화된 상태로 저장할 수 있게 개선됐다.
- 테이블 암호화는 적용되면 해당 테이블의 모든 데이터가 암호화되나, 리두 혹은 언두 로그는 적용 시점의 이후 부터 암호화된다.
  - 복호화도 마찬가지이므로 며칠 또는 몇 달 동안 암호화키가 필요할 수 있다.

-----------

## 바이너리 로그 암호화

- 일반적으로 언두 로그와 리두 로그는 길지 않은 시간 동안의 데이터만 가지기 때문에 크게 보안에 민감하지 않을 수 있지만 바이너리 로그는 의도적으로
상당히 긴 시간 동안 보관하는 서비스도 있고 증분 백업을 위해 보관하기도 하기 때문에 암호화가 상황에 따라 중요해질 수 있다.
- 바이너리 로그와 릴레이 로그 파일 암호화 기능은 디스크에 저장된 로그 파일에 대한 암호화만 담당하고 MySQL 서버의 메모리 내부 또는 소스 서버와
레플리카 서버 간의 네트워크 구간에서 로그 데이터를 암호화하지 않는다.
- SSL을 사용하면 복제 시 네트워크 구간으로 전송되는 데이터도 암호화된다.