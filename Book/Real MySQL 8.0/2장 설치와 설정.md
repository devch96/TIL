# 설치와 설정

----------

## MySQL 서버 설치

### 버전과 에디션(엔터프라이즈와 커뮤니티) 선택

- 갓 출시된 메이저 버전을 선택하는 것은 치명적이거나 보완하는 데 많은 시간이 걸릴 만한 버그가 발생할 수 있으므로
조심해야 한다.
- 다음과 같은 부가적인 기능과 서비스들은 엔터프라이즈 에디션에서만 지원된다.
  - Thread Pool
  - Enterprise Audit
  - Enterprise TDE(Master Key 관리)
  - Enterprise Authentication
  - Enterprise Firewall
  - Enterprise Monitor
  - Enterprise Backup
  - MySQL 기술 지원

### MySQL 설치

- MySQL 서버가 설치된 디렉터리는 /usr/local/mysql이며, 다음 디렉터리들은 절대 삭제하면 안 된다.
  - bin: MySQL 서버와 클라이언트 프로그램, 유틸리티를 위한 디렉터리
  - data: 로그 파일과 데이터 파일들이 저장되는 디렉터리
  - include: C/C++ 헤더 파일들이 저장된 디렉터리
  - lib: 라이브러리 파일들이 저장된 디렉터리
  - share: 다양한 지원 파일들이 저장돼 있으며, 에러 메시지나 샘플 설정 파일(my.cnf)이 있는 디렉터리

--------------------

## MySQL 서버의 시작과 종료

- 리눅스 서버에서 Yum 으로 MySQL 서버를 설치하면 MySQL 서버에 필요한 프로그램들과 디렉터리들은 일부 준비되지만 트랜잭션 로그 파일과
시스템 테이블이 준비되지 않았기 때문에 시작할 수 없다.

```java
mysqld --defaults-file=/etc/my.cnf --initialize-insecure
```
- --initialize-insecure 옵션을 사용하면, 필요한 초기 데이터 파일과 로그 파일들을 생성하고 비밀번호가 없는
관리자 계정인 root 유저를 생성한다.

### 시작과 종료

- 유닉스 계열 운영체제에서 RPM 패키지로 MySQL을 설치했다면 자동으로 /usr/lib/systemd/system/mysqld.service 파일이 생성되고,
systemctl 유틸리티를 이용해 MySQL을 가동하거나 종료하는 것이 가능하다.

```shell
systemctl start mysqld
systemctl stop mysqld
```

- 서버를 종료할때 실제 트랜잭션이 정상적으로 커밋돼도 데이터 파일에 변경된 내용이 기록되지 않고 로그 파일에만 기록돼 있을 수 있다.
- MySQL 서버가 종료될 때 모든 커밋된 내용을 데이터 파일에 기록하고 종료하게 할 수 있다.

```shell
mysql> SET GLOBAL innodb_fast_shutdown=0;
linux> systemctl stop mysqld.service
```

- 모든 커밋된 데이터를 데이터 파일에 적용하고 종료하는 것을 클린 셧다운이라고 표현한다.
- 클린 셧다운으로 종료되면 다시 MySQL 서버가 가동할 때 별도의 트랜잭션 복구 과정을 진행하지 않기 때문에 빠르게 시작할 수 있다.

### 서버 연결 테스트

- MySQL 서버에 접속하는 방법은 MySQL 서버 프로그램(mysqld)과 함께 설치된 MySQL 기본 클라이언트 프로그램인 mysql을 실행하면 된다.

```shell
mysql -uroot -p --host=localhost --socket=/tmp/mysql.sock
mysql -uroot -p --host=127.0-.0.1 --port=3306
mysql -uroot -p
```

- 첫 번째 예제는 MySQL 소켓 파일을 이용해 접속하는 예제다.
- 두 번째 예제는 TCP/IP를 통해 접속하는 예제인데 포트를 명시하는 것일 일반적이다.
  - 로컬 서버에 설치된 MySQL이 아니라 원격 호스트에 있는 MySQL 서버에 접속할 때는 반드시 두 번째 방법을 사용해야 한다.
  - 호스트를 localhost로 명시하는 것과 127.0.0.1로 명시하는 것은 의미가 다르다.
    - localhost 옵션을 사용하면 소켓 파일을 통해 접속한다.
    - 127.0.0.1은 TCP/IP 통신 방식을 사용한다.
- 세 번째 예제는 호스트 주소와 포트를 명시하지 않는데 이 경우에는 기본값으로 호스트는 localhost가 되며 소켓 파일을 사용한다.
- MySQL 서버를 직접 로그인하지 않고, 원격 서버에서 MySQL 서버의 접속 가능 여부만 확인해야 하는 경우가 있다.
- 커넥션이 가능한지만 확인하는 경우에는 MySQL 클라이언트를 설치하는 작업이 번거롭거나 보안상 이유로 MySQL 클라이언트 프로그램을 설치하지 못할 수 있다.
- telnet 명령이나 nc 명령을 이용해 응답 가능한 상태인지 확인해볼 수 있다.
```shell
telnet 10.2.40.61 3306
nc 10.2.40.61 3306
```

------------

## MySQL 서버 업그레이드

- 두 가지 방법이 있다.
  - MySQL 서버의 데이터 파일을 그대로 두고 업그레이드하는 방법
  - mysqldump 도구 등을 이용해 MySQL 서버의 데이터를 SQL 문장이나 텍스트 파일로 덤프한 후, 새로 업그레이드된 버전의 MySQL 서버에서 덤프된 데이터를
  적재하는 방법
- 전자를 인플레이스 업그레이드(In-Place Upgrade), 후자를 논리적 업그레이드(Logical Upgrade)라고 한다.
- 인플레이스 업그레이드는 여러 가지 제약 사항이 있지만 업그레이드 시간을 크게 단축할 수 있고, 논리적 업그레이드는 버전 간 제약 사항이 거의 없지만
업그레이드 시간이 매우 많이 소요될 수 있다.

### 인플레이스 업그레이드 제약 사항

- 메이저 버전 간 업그레이드는 대부분 크고 작은 데이터 파일의 변경이 필요하기 때문에 반드시 직전 버전에서만 업그레이드가 허용된다
  - 5.5 버전에서 5.6은 되지만, 5.5 버전에서 5.7 버전으로는 불가하다.
- 메이저 버전 업그레이드를 할 때는 MySQL 서버의 매뉴얼을 정독한 후 진행해야 한다.

### MySQL 8.0 업그레이드 시 고려 사항

- 사용자 인증 방식 변경
  - MySQL 8.0 버전부터는 Caching SHA-2 Authentication 인증 방식이 기본 인증 방식으로 바뀌었다.
  - Native Authentication을 계속 사용하고자 한다면 MySQL 서버를 시작할 때 --default-authentication-plugin-mysql_native_password 파라미터를
  활성화해야 한다.
- MySQL 8.0과의 호환성 체크
  - MySQL 8.0 업그레이드 전에 MySQL 5.7 버전에서 손상된 FRM 파일이나 호환되지 않는 데이터 타입 또는 함수가 있는지 mysqlcheck 유틸리티를
  이용해 확인해봐야 한다.
- 외래키 이름의 길이
  - MySQL 8.0에서는 외래키의 이름이 64글자로 제한된다.
- 인덱스 힌트
  - MySQL 5.x에서 사용되던 인덱스 힌트가 있다면 MySQL 8.0에서 먼저 성능 테스트를 해야한다.
    - 5.x에서는 성능 향상에 도움이 됐지만 8.x에서는 오히려 성능저하를 일으킬 수 있다.
- GROUP BY에 사용된 정렬 옵션
  - MySQL 5.x에서 GROUP BY 절의 칼럼 뒤에 'ASC' 나 'DESC"를 사용하고있다면 먼저 제거하거나 다른 방식으로 변경해야 한다.
- 파티션을 위한 고용ㅇ 테이블스페이스
  - MySQL 8.x에서는 파티션의 각 테이블스페이스를 공용 테이블스페이스에 저장할 수 없다.


--------------

## 서버 설정

- MySQL 서버는 단 하나의 설정 파일을 사용하는데 유닉스 계열에서는 my.cnf, 윈도우 계열에서는 my.ini라는 이름을 사용한다.
- MySQL 서버가 어느 디렉터리에서 my.cnf 파일을 읽는지 궁금하다면 mysqld 프로그램을 --verbose --help 옵션을 주어 실행해보면 된다.

### MySQL 시스템 변수의 특징

- MySQL 서버는 기동하면서 설정 파일의 내용을 읽어 메모리나 작동 방식을 초기화하고, 접속된 사용자를 제어하기 위해 값을 별도로 저장해둔다.
- SHOW VARIABLES 또는 SHOW GLOBAL VARIABLES라는 명령으로 확인할 수 있다.

### 글로벌 변수와 세션 변수

- MySQL의 시스템 변수는 적용 범위에 따라 글로벌 변수와 세션 변수로 나뉘는데, 일반적으로 세션별로 적용되는 시스템 변수의 경우 글로벌 변수뿐만 아니라 세션 변수에도
동시에 존재한다.
- 글로벌 범위의 시스템 변수는 하나의 MySQL 서버 인스턴스에서 전체적으로 영향을 미치는 시스템 변수를 의미하며, 주로 MySQL 서버 자체와 관련된 설정일 때가 많다.
  - InnoDB 버퍼 풀 크기, 키 캐시 크기 등이 가장 대표적인 글로벌 영역의 시스템 변수
- 세션 범위의 시스템 변수는 MySQL 클라이언트가 MySQL 서버에 접속할 때 기본으로 부여하는 옵션의 기본값을 제어하는 데 사용된다.
- 세션 범위의 시스템 변수 가운데 MySQL 서버의 설정 파일에 명시해 초기화할 수 있는 변수는 대부분 범위가 Both 라고 명시돼 있다.

### 정적 변수와 동적 변수

- MySQL 서버의 시스템 변수는 MySQL 서버가 기동 중인 상태에서 변경 가능한지에 따라 동적 변수와 정적 변수로 구분된다.
- MySQL 8.0 버전부터는 SET PERSIST 명령을 이용하면 실행 중인 MySQL 서버의 시스템 변수를 변경함과 동시에 자동으로 설정 파일로도 기록된다.
- 일반적으로 글로벌 시스템 변수는 MySQL 서버의 기동 중에는 변경할 수 없는 것이 많지만 실시간으로 변경할 수 있는 것도 있다.

### SET PERSIST

- 동적 변수의 경우 MySQL 서버에서 SET GLOBAL 명령으로 변경하면 즉시 MySQL 서버에 반영된다.
- MySQL 서버의 설정 파일에서도 이 내용을 적용해야 하는데 이러기 위해선 SET PERSIST 명령을 사용해야 한다.
