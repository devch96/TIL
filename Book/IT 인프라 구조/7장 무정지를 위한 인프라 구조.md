# 무정지를 위한 인프라 구조

------------

## 안정성 및 이중화

### 안정성이란?

- 시스템 인프라가 '업무 기능의 토대'가 되지만 요구되는 몇 가지가 있는데 그 중 하나가 안정성이다.
- 고가용성이라고 한다.
- 안정성, 고가용성이란, 시스템 서비스가 가능한 한 멈추지 않도록 하는 것을 말한다.
- 안정성, 고가용성의 목표
  - 고장, 장애에 의한 정지가 발생하지 않을 것(컴포넌트 이중화로 실현)
    - 하드웨어에서는 MTBF(Mean Time Between Failure, 평균 장애 지속 시간)이라고 한다.
  - 고장 , 장애가 발생해도 복구할 수 있을 것(컴포넌트 이중화로 실현)
    - 하드웨어에서는 MTTR(Mean Time To Repair, 평균 복구 시간)이라고 한다
  - 고장, 장애가 발생한 것을 검출할 수 있을 것(컴포넌트 감시로 실현)
  - 고장, 장애가 발생해도 데이터가 보호될 것(데이터 백업으로 실현)

### 이중화란?

- 하나의 기능을 병렬로 여러 개 나열해서 하나에 장애가 발생해도 다른 것을 이요해서 서비스를 계속할 수 있는 것.
- 하나의 기능이 병렬로 가동되기 때문에 이런 고가용성에 대한 의미뿐만 아니라 확장성이나 부하 분산 같은 성능에 대한 의미도 가짐.
- 이중화 할때 필요한 구조
  - 부하분산
  - 내부적 생존 감시
  - 마스터 결정
  - 페일 오버

--------------------

## 서버 내 이중화

### 전원, 장치 등의 이중화

- 서버 내부 컴포넌트에서는 전원, 팬 등이 이중화 돼 있어서 하나가 망가져도 서버가 정상 가동하도록 설계돼 있다.
- 랙 뒤쪽의 양 끝에는 전원 탭이 붙어있는데 각각 전원 탭에 접속해서 한쪽이 망가져도 다른쪽으로 사용한다.

### 네트워크 인터페이스 이중화

- PCI 슬롯에 꽂은 카드도 이중화가 가능하다.
- 네트워크 인터페이스나 파이버 채널 포트에는 이중화 기능이나 이중화를 실현하는 소프트웨어가 있다.

#### 장애가 발생하면 어떻게 하나?

- 액티브-스탠바이 구성은 마스터-워커 개념에 기반한 것으로 스탠바이 측은 보통 서비스를 제공하지 않는다.
- 액티브 측에 어떤 문제가 발생하면 스탠바이 장비로 교체돼서 스탠바이가 액티브로 변경된다.
- 이렇게 교체하는 것을 페일오버(Failover)라고 한다.


--------------------------

## 저장소 이중화

### HDD 이중화

- 저장소 이중화의 주요 대상은 가동 빈도가 높아서 고장 나기 쉬운 HDD다.

### 저장소 내부 구조와 RAID

- RAID는 여러 HDD를 묶어서 그룹으로 만들고 이것을 논리적인 HDD로 인시갛는 기술이다.
- 논리적 HDD를 LU(Local Unit)라고 한다.
- 서버가 인식하는 HDD는 LU다.
- RAID의 장점
  - 안정성 확보
    - HDD에 장애가 발생해도 데이터가 손실되지 않도록 데이터 기록을 이중화한다.
  - 성능 향상
    - RAID 컨트롤러가 미리 정해놓은 길이로 I/O를 분할해서 복수의 HDD에 대해 병렬로 I/O 처리를 한다.
    - 이 고정 길이를 RAID의 스트라이프(Stripe) 크기라고 부른다
  - 용량 확장
    - 논리 HDD는 물리적 한계를 넘어서 자유롭게 용량을 결정할 수 있다.

#### RAID 구성 패턴

- RAID5 는 이중화 확보를 위해 패리티라는 오류 수정 부호를 기록한다.
- RAID1 은 일반적으로 OS 디스크 이중화에 사용한다.
- RAID10은 RAID0과 RAID1을 조합한 구성이다.
- RAID0은 이중화 없이 HDD에 기록하는 방식이다.
- RAID5에서는 패리티 연산이 이루어지기 때문에 I/O 성능이 RAID10에 비해 느리다. 하지만 RAID10은 미러링을 하기 때문에 HDD 전체 용량의 1/2 용량 밖에
사용할 수 없다.

#### 장애가 발생하면 어떻게 되나?

1. 미러링이 I/O를 기록한다.
2. 이중화 회복을 위해 핫 스페어라고 하는 빈 디스크에 데이터를 복사한다
3. HDD를 교환한 후에 핫 스페어로부터 데이터를 복구하는 경우도 있다

### 버스 이중화

- 서버와 저장소 사이에 있는 버스도 이중화 한다.
- Red Hat Enterprise Linus의 DM-Multipath 버스 이중화 기능
  1. 사용자가 파일을 기록한다.
  2. 파일 시스템에서 고정 길이 블록으로 처리된다.
  3. 파일 시스템 캐시를 디스크에 푸시할 때 장치 관리자의 multipath 기능이 블록 기록 처리를 현재 디스크의 I/O 버스에 할당한다.
  4. I/O 스케줄러에 의해 I/O 요청 큐에 저장된다
  5. HBA 드라이버가 큐 순서에 따라 HBA를 사용해 저장소에 기록한다.

-----------------------------

## 웹 서버 이중화

### 웹 서버의 서버 내 이중화

- 클라이언트 관점에서는 서버 측이 프로세스로 가동되고 있는지, 스레드로 가동되고 있는지 의식할 필요는 없다.
- 미리 여러개를 가동시켜 두어서 클라이언트 요청에 빠르게 대응하는 구성을 취한다.

#### 장애가 발생하면 어떻게 되나?

- httpd 프로세스/스레드가 요청을 받을 수 없는 경우엔 서버 측 문제이기 때문에 500번대 에러를 클라이언트에 반환한다.

### 서버 이중화

- 웹 서버를 이중화하는 방법 중 하나가 DNS를 이용해서 하나의 호스트명에 대해 복수의 IP 주소를 반환하는 것이다.
- 이 기법을 DNS 라운드 로빈(Round Robin)이라고 한다.
- DNS는 질의에 대해 순서대로 IP 주소를 반환한다.
- 이 방법은 간단하게 서버를 이중화할 수 있다는 이점이 있지만 몇 가지 주의 사항이 있다.
  - DNS가 서버 상태를 감시해서 파악하지 않기 때문에 서버가 정지된 경우에도 그 서버의 주소를 반환한다.(가용성을 중시하는 경우에는 부적합)
  - DNS가 세션 상태를 파악하지 않기 때문에 다음 접속 시에 동일 서버에 접속해야 하는 경우에도 부적합하다

#### 부하분산 장치를 이용한 웹서버 이중화

- 이런 제약 사항 때문에 조금 더 고도화한 이중화 방식이 부하분산 장치(로드 밸런서)다.
- 로드 밸런서는 이전에 어느 웹 서버에 요청을 할당했는지를 쿠키에 저장하고 있다.
- 클라이언트 측에서 쿠키 사용을 허가하면 두 번째 이후 접속부터 HTTP 요청 헤더에 쿠키를 저장해서 접속한다.
- 부하분산 장치는 이 쿠키를 읽어서 같은 서버에 요청을 할당한다.
- 부하분산 장치는 임시 대응 관리표로 세션 테이블을 만드는데 클라이언트에 요청을 반환할 때 이 테이블을 참조한다.
- 세션 상태 기능을 실현하는 기능을 부하분산 장치에서는 퍼시스턴스 기능이라고 한다.
- 주요 퍼시스턴스
  - 소스 IP 주소
    - 클라이언트 IP 주소를 기반으로 요청을 할당할 웹 서버 결정(IP 끝자리가 홀수이면 웹서버 1에 할당하는 등)
  - 쿠키
    - HTTP 헤더 내에 접속한 웹 서버 정보를 저장한다
  - URL
    - URL 구조 내에 접속한 웹 서버 정보를 저장한다
- 출발지 IP 주소를 이용한 퍼시스턴스는 프록시를 경유하면 프록시 서버의 IP 주소가 클라이언트 IP 주소가 돼서 요청이 한쪽으로 몰릴 수 있다.
- 쿠키를 사용하는 경우는 각 AP 서버 등이 쿠키를 사용할 때 부하분산 장치가 부여한 쿠키를 덮어쓰기하지 않는지 확인해야 한다.
- URL에 정보를 심는 경우 URL은 사용자가 직접 편집 가능한 정보이기 땜누에 부정 접속에 대한 대책을 검토해 두어야 한다.
- 부하분산장치의 할당 알고리즘
  - 라운드 로빈(Round Robin)
    - 서버의 IP 주소에 순서대로 요청을 할당한다
  - 최소 연결(Least Connection)
    - 현재 활성 세션 수보다 세션 수가 가장 적은 서버의 IP 주소에 요청을 할당한다
  - 응답 시간(Response Time)
    - 서버의 CPU 사용률이나 응답 시간 등을 고려해서 가장 부하가 적은 서버의 IP 주소에 요청을 할당한다.

#### 장애가 발생하면 어떻게 되나?

- 부하분산 장치는 웹 서버의 가동 상태를 감시할 수 있기 때문에 장애를 감지한 경우 클라이언트의 요청을 동적으로 다른 서버에 할당(페일오버)할 수 있다.
- 하지만 이 기능에 한가지 문제가 있다.
- 정적 콘텐츠만 있는 경우엔 상관없지만 동적 콘텐츠(세션 정보 등)이 있는 경우엔 정보 손실이 발생할 수 있다.


----------------------------

## AP 서버 이중화

### 서버 이중화

- AP 서버 이중화는 두 가지 기능을 이용해서 구현한다
  - 웹 서버와 같이 부하분산 장치를 이용하거나, AP 서버가 가진 웹 서버 요청 이중화 기능을 이용해서 AP 서버 요청을 분산시키는 것
  - 세션 정보 이중화
