# 무정지를 위한 인프라 구조

------------

## 안정성 및 이중화

### 안정성이란?

- 시스템 인프라가 '업무 기능의 토대'가 되지만 요구되는 몇 가지가 있는데 그 중 하나가 안정성이다.
- 고가용성이라고 한다.
- 안정성, 고가용성이란, 시스템 서비스가 가능한 한 멈추지 않도록 하는 것을 말한다.
- 안정성, 고가용성의 목표
  - 고장, 장애에 의한 정지가 발생하지 않을 것(컴포넌트 이중화로 실현)
    - 하드웨어에서는 MTBF(Mean Time Between Failure, 평균 장애 지속 시간)이라고 한다.
  - 고장 , 장애가 발생해도 복구할 수 있을 것(컴포넌트 이중화로 실현)
    - 하드웨어에서는 MTTR(Mean Time To Repair, 평균 복구 시간)이라고 한다
  - 고장, 장애가 발생한 것을 검출할 수 있을 것(컴포넌트 감시로 실현)
  - 고장, 장애가 발생해도 데이터가 보호될 것(데이터 백업으로 실현)

### 이중화란?

- 하나의 기능을 병렬로 여러 개 나열해서 하나에 장애가 발생해도 다른 것을 이요해서 서비스를 계속할 수 있는 것.
- 하나의 기능이 병렬로 가동되기 때문에 이런 고가용성에 대한 의미뿐만 아니라 확장성이나 부하 분산 같은 성능에 대한 의미도 가짐.
- 이중화 할때 필요한 구조
  - 부하분산
  - 내부적 생존 감시
  - 마스터 결정
  - 페일 오버

--------------------

## 서버 내 이중화

### 전원, 장치 등의 이중화

- 서버 내부 컴포넌트에서는 전원, 팬 등이 이중화 돼 있어서 하나가 망가져도 서버가 정상 가동하도록 설계돼 있다.
- 랙 뒤쪽의 양 끝에는 전원 탭이 붙어있는데 각각 전원 탭에 접속해서 한쪽이 망가져도 다른쪽으로 사용한다.

### 네트워크 인터페이스 이중화

- PCI 슬롯에 꽂은 카드도 이중화가 가능하다.
- 네트워크 인터페이스나 파이버 채널 포트에는 이중화 기능이나 이중화를 실현하는 소프트웨어가 있다.

#### 장애가 발생하면 어떻게 하나?

- 액티브-스탠바이 구성은 마스터-워커 개념에 기반한 것으로 스탠바이 측은 보통 서비스를 제공하지 않는다.
- 액티브 측에 어떤 문제가 발생하면 스탠바이 장비로 교체돼서 스탠바이가 액티브로 변경된다.
- 이렇게 교체하는 것을 페일오버(Failover)라고 한다.


--------------------------

## 저장소 이중화

### HDD 이중화

- 저장소 이중화의 주요 대상은 가동 빈도가 높아서 고장 나기 쉬운 HDD다.

### 저장소 내부 구조와 RAID

- RAID는 여러 HDD를 묶어서 그룹으로 만들고 이것을 논리적인 HDD로 인시갛는 기술이다.
- 논리적 HDD를 LU(Local Unit)라고 한다.
- 서버가 인식하는 HDD는 LU다.
- RAID의 장점
  - 안정성 확보
    - HDD에 장애가 발생해도 데이터가 손실되지 않도록 데이터 기록을 이중화한다.
  - 성능 향상
    - RAID 컨트롤러가 미리 정해놓은 길이로 I/O를 분할해서 복수의 HDD에 대해 병렬로 I/O 처리를 한다.
    - 이 고정 길이를 RAID의 스트라이프(Stripe) 크기라고 부른다
  - 용량 확장
    - 논리 HDD는 물리적 한계를 넘어서 자유롭게 용량을 결정할 수 있다.

#### RAID 구성 패턴

- RAID5 는 이중화 확보를 위해 패리티라는 오류 수정 부호를 기록한다.
- RAID1 은 일반적으로 OS 디스크 이중화에 사용한다.
- RAID10은 RAID0과 RAID1을 조합한 구성이다.
- RAID0은 이중화 없이 HDD에 기록하는 방식이다.
- RAID5에서는 패리티 연산이 이루어지기 때문에 I/O 성능이 RAID10에 비해 느리다. 하지만 RAID10은 미러링을 하기 때문에 HDD 전체 용량의 1/2 용량 밖에
사용할 수 없다.

#### 장애가 발생하면 어떻게 되나?

1. 미러링이 I/O를 기록한다.
2. 이중화 회복을 위해 핫 스페어라고 하는 빈 디스크에 데이터를 복사한다
3. HDD를 교환한 후에 핫 스페어로부터 데이터를 복구하는 경우도 있다

### 버스 이중화

- 서버와 저장소 사이에 있는 버스도 이중화 한다.
- Red Hat Enterprise Linus의 DM-Multipath 버스 이중화 기능
  1. 사용자가 파일을 기록한다.
  2. 파일 시스템에서 고정 길이 블록으로 처리된다.
  3. 파일 시스템 캐시를 디스크에 푸시할 때 장치 관리자의 multipath 기능이 블록 기록 처리를 현재 디스크의 I/O 버스에 할당한다.
  4. I/O 스케줄러에 의해 I/O 요청 큐에 저장된다
  5. HBA 드라이버가 큐 순서에 따라 HBA를 사용해 저장소에 기록한다.

-----------------------------

## 웹 서버 이중화

### 웹 서버의 서버 내 이중화

- 클라이언트 관점에서는 서버 측이 프로세스로 가동되고 있는지, 스레드로 가동되고 있는지 의식할 필요는 없다.
- 미리 여러개를 가동시켜 두어서 클라이언트 요청에 빠르게 대응하는 구성을 취한다.

#### 장애가 발생하면 어떻게 되나?

- httpd 프로세스/스레드가 요청을 받을 수 없는 경우엔 서버 측 문제이기 때문에 500번대 에러를 클라이언트에 반환한다.

### 서버 이중화

- 웹 서버를 이중화하는 방법 중 하나가 DNS를 이용해서 하나의 호스트명에 대해 복수의 IP 주소를 반환하는 것이다.
- 이 기법을 DNS 라운드 로빈(Round Robin)이라고 한다.
- DNS는 질의에 대해 순서대로 IP 주소를 반환한다.
- 이 방법은 간단하게 서버를 이중화할 수 있다는 이점이 있지만 몇 가지 주의 사항이 있다.
  - DNS가 서버 상태를 감시해서 파악하지 않기 때문에 서버가 정지된 경우에도 그 서버의 주소를 반환한다.(가용성을 중시하는 경우에는 부적합)
  - DNS가 세션 상태를 파악하지 않기 때문에 다음 접속 시에 동일 서버에 접속해야 하는 경우에도 부적합하다

#### 부하분산 장치를 이용한 웹서버 이중화

- 이런 제약 사항 때문에 조금 더 고도화한 이중화 방식이 부하분산 장치(로드 밸런서)다.
- 로드 밸런서는 이전에 어느 웹 서버에 요청을 할당했는지를 쿠키에 저장하고 있다.
- 클라이언트 측에서 쿠키 사용을 허가하면 두 번째 이후 접속부터 HTTP 요청 헤더에 쿠키를 저장해서 접속한다.
- 부하분산 장치는 이 쿠키를 읽어서 같은 서버에 요청을 할당한다.
- 부하분산 장치는 임시 대응 관리표로 세션 테이블을 만드는데 클라이언트에 요청을 반환할 때 이 테이블을 참조한다.
- 세션 상태 기능을 실현하는 기능을 부하분산 장치에서는 퍼시스턴스 기능이라고 한다.
- 주요 퍼시스턴스
  - 소스 IP 주소
    - 클라이언트 IP 주소를 기반으로 요청을 할당할 웹 서버 결정(IP 끝자리가 홀수이면 웹서버 1에 할당하는 등)
  - 쿠키
    - HTTP 헤더 내에 접속한 웹 서버 정보를 저장한다
  - URL
    - URL 구조 내에 접속한 웹 서버 정보를 저장한다
- 출발지 IP 주소를 이용한 퍼시스턴스는 프록시를 경유하면 프록시 서버의 IP 주소가 클라이언트 IP 주소가 돼서 요청이 한쪽으로 몰릴 수 있다.
- 쿠키를 사용하는 경우는 각 AP 서버 등이 쿠키를 사용할 때 부하분산 장치가 부여한 쿠키를 덮어쓰기하지 않는지 확인해야 한다.
- URL에 정보를 심는 경우 URL은 사용자가 직접 편집 가능한 정보이기 땜누에 부정 접속에 대한 대책을 검토해 두어야 한다.
- 부하분산장치의 할당 알고리즘
  - 라운드 로빈(Round Robin)
    - 서버의 IP 주소에 순서대로 요청을 할당한다
  - 최소 연결(Least Connection)
    - 현재 활성 세션 수보다 세션 수가 가장 적은 서버의 IP 주소에 요청을 할당한다
  - 응답 시간(Response Time)
    - 서버의 CPU 사용률이나 응답 시간 등을 고려해서 가장 부하가 적은 서버의 IP 주소에 요청을 할당한다.

#### 장애가 발생하면 어떻게 되나?

- 부하분산 장치는 웹 서버의 가동 상태를 감시할 수 있기 때문에 장애를 감지한 경우 클라이언트의 요청을 동적으로 다른 서버에 할당(페일오버)할 수 있다.
- 하지만 이 기능에 한가지 문제가 있다.
- 정적 콘텐츠만 있는 경우엔 상관없지만 동적 콘텐츠(세션 정보 등)이 있는 경우엔 정보 손실이 발생할 수 있다.


----------------------------

## AP 서버 이중화

### 서버 이중화

- AP 서버 이중화는 두 가지 기능을 이용해서 구현한다
  - 웹 서버와 같이 부하분산 장치를 이용하거나, AP 서버가 가진 웹 서버 요청 이중화 기능을 이용해서 AP 서버 요청을 분산시키는 것
  - 세션 정보 이중화

#### 웹로직 서버의 세션 복제

1. AP 서버를 선정해서 요청을 AP 서버에 리다이렉션한다(웹 서버)
2. 세션 정보를 작성해서 클러스터 내 다른 서버에 복제한다(AP 서버)
3. 세션 정보가 저장된 서버(기본/보조) 정보를 쿠키의 JSESSIONID에 추가해서 반환한다

#### 장애가 발생하면 어떻게 되나?

1. 쿠키 정보로부터 AP 서버 1에 리다이렉션해서 실패를 감지한다.
2. 보조 세션이 승격해서 기본 세션이 돼서 리다이렉션 된다.
3. AP 서버 3에는 세션 정보가 없기 때문에 AP 서버 2에서 복사한다.
4. 세션 정보가 저장돼 있는 서버(기본/보조) 정보를 쿠키의 JSESSIONID에 추가해서 반환한다.

### DB 연결 이중화

- AP 서버는 3계층형 시스템의 중간에 위치한다.
- AP 서버에는 DB 서버에 접속 시에 사용할 연결을 사전에 여러 개 생성해 두는 기능이 있다.
  - 연결 풀링(Connection Pooling)이라고 한다.
  - 데이터 소스를 설정해서 이용한다.
- 애플리케이션은 연결 해제를 하지 않기 때문에 연결 생성 및 해제 시에 걸리는 시간이나 리소스가 필요 없어서 고속으로 처리할 수 있다.

#### 장애가 발생하면 어떻게 되나?

- 감시에 두 번 실패하면 연결을 일단 끊은 후 재접속한다.
- 연결이 모두 사용중인 경우에는 설정 최댓값까지 연결 수가 늘며, 최댓값을 초과한 요구가 오면 일정 시간 대기 한다.

#### 연결이나 세션 설계에 대한 일반적 개념

- 최솟값과 최댓값을 동일하게 설정한다
  - 연결을 생성하거나 제거할 때 발생하는 오버헤드를 가능한 한 경감시키기 위해서이다.
  - 이와 같이 설정하면 연결 오버헤드를 초기 가동 시에만 집중시키는 것이 가능하다.
- 방화벽 유무를 확인해 둔다
  - 중간에 방화벽이 있다면 오랫동안 사용하지 않은 세션을 자동으로 제거하는 경우가 있기 때문에 방화벽 유무를 확인해야 한다.
  - 연결돼 있는 동안 소켓은 Establish 상태이지만, 실제 데이터 교환이 없으면 중간의 네트워크 장비는 해당 연결을 대기 상태로 간주한다.
  - 방화벽에서는 보안상의 이유로 장시간 대기 상태인 연결을 절단하는 기능이 있기 때문에 의도하지 않은 절단이 발생할 수 있어서
  정기적으로 폴링하는 등의 대책을 마련해야 된다.

-----------------

## DB 서버 이중화

### 서버 이중화(액티브-스탠바이)

- 액티브-스탠바이형의 클러스터(Cluster)구성
- 클러스터 구성은 하드웨어로도 구현할 수 있지만, 일반적으로 클러스터 소프트웨어를 이용한다.
- 액티브 DB서버는 처리를 하면서 서비스를 제공하고, 공유 디스크에 투표 장치라고 하는 곳에 자신의 상태를 기록한다.
- 스탠바이 DB서버는 OS가 가동괴도 있지만 서비스는 제공하지 않는다.

#### 장애가 발생하면 어떻게 되나?

1. 액티브의 장애를 감지한다
2. 각 노드의 상태가 기록된다.
2. 액티브는 스탠바이로 변경되고 서비스를 정지하거나 OS를 재시작한다.
3. 스탠바이는 액티브 측이 정지된 것을 인식하고 서비스를 시작한다(액티브가 된다)

#### 스플릿 브래인

- 클러스터 소프트웨어는 하트비트를 이용해서 상호 간의 상태를 확인한다.
- 이 때문에 하트비트를 통해 상태를 인식할 수 없게 되면, 클러스터 소프트웨어는 페일오버 실시 여부를 판단할 수 없게 되는데 이런 상태를 스플릿 브레인(Split-brain)
라고 한다.
- 2노드 클러스터는 빠른 측이 이기지만, 3노드 이상의 클러스터는 다수결(상호 인식한 수가 많은 노드)로 진행된다

#### 클러스터 구성용 서비스란?

- 클러스터 소프트웨어를 이용한 액티브-스탠바이 구성은 서비스를 병렬로 실행할 수 없고 데이터 일관성을 중시하는 서비스/시스템에 적합하다
  - 데이터베이스, 파일 서버, 잡(Job) 관리 시스템 등
- 데이터 갱신이 거의 없어서 데이터 일관성이 중시되지 않고, 서비스 병렬 실행이 가능한 웹 서버나 AP 서버에서는 클러스터 소프트웨어를 사용하지 않는다.

### 서버 이중화(액티브-액티브)

- 쉐어드 에브리씽형(Shared Everything)
  - 디스크, 데이터를 모든 노드가 공유한다.
  - 장애가 발생해고 다른 노드로 쉽게 처리를 계속할 수 있다.
  - 메모리 데이터의 일치성을 확인할 필요가 있기 때문에 확장이 쉽지 않음.
  - 노드 간 배타적 제어나 데이터 경합을 하기 때문에 처리 속도가 저하

- 쉐어드 낫씽형(Shared Nothing)
  - 각 노드별로 디스크를 가지고 있어서 데이터가 분산된다.
  - 노드를 배치하기 쉽다.
  - 대량의 데이터를 검색하는 경우 데이터가 분산돼 있기 때문에 유리
  - 작은 트랜잭션이 대량으로 발생하는 경우도 노드 추가를 통해 쉽게 확장할 수 있기 때문에 유리
  - 하지만 확장 시에 데이터 재배치를 검토 및 설계해야 하기 때문에 확장이 어려움
  - 갱신 시에 데이터 분산 위치를 검토하기 때문에 전반적인 갱신 처리가 늦음
- 시스템 특성에 따라 해당 시스템의 병목 현상이나 장애 시 영향 등을 고려해서 선택해야 함
- 클라우드상에 구현할 때는 쉐어드 낫씽형이 많음(쉐어드 에브리씽형에선 공유 디스크가 필수로, 클라우드에선 구성이 어려움)

------------------

## 감시

### 감시란?

- 시스템 컴포넌트가 정상 동작하는지 확인하는 기능
- 감시의 종류
  - 생존 감시
  - 로그(에러) 감시
  - 성능 감시
- 감시에서 중요한 것은 어떤 목적으로 감시 기능이 필요한지, 특정 컴포넌트에 감시가 너무 중복돼 있지 않은지 등을 고려하는 것.

### 생존 감시

- ping 명령을 정기적으로 실행해서 서버 인터페이스에 대한 통신을 확인하는 감시로, 생존 감시라고 하며 ping 감시라고 부른다.
  - 구현이 매우 쉬워서 모든 장비에 설정할 것을 권장
- 프로세스 감시는 실행 중인 프로세스 모두를 감시하는 것이 아니라 중요한 것만 추려서 감시하는 것이 좋다.

### 로그 감시

- OS나 미들웨어가 출력하는 로그 파일에는 시스템 유지를 위한 중요 정보가 포함돼 있다. 
- 감시 프로세스는 로그 파일에 새로운 출력이 있으면 패턴에 해당하는 내용이 있는지 확인하고 해당하는 경우 통지를 보낸다
- 대부분의 미들웨어 로그는 alert이나 error 등의 문자열을 붙여서 출력하기 때문에 alert이나 error 같은 키워드를 등록해 둔다.

### 성능 감시

- 디스크 사용률이나 메모리 사용 현황, 디스크 고갈 등의 리소스 상태 파악과 네트워크 액세스 지연, 디스크 액세스 시간 등의 응답 상태를 파악하는 것이다.
- df 명령 등의 OS 명령을 정기적으로 실행하거나, vmstat 명령이나 sar 명령 등의 통ㄱ켸 정보를 취득해서 상황을 통계적으로 판단하는 등 다양한 방식이 가능하다.

### SNMP

- 통합 감시 툴로 상용 제품이 다수 존재하며 히타치의 JP1, IBM의 티볼리 등이 대표적이다.
- 오픈 소스인 Zabbix나 Nagios와 같은 툴로 상용 환경을 감시하는 경우도 늘고 있다.
- 이 기능들이 기반으로 하고 있는 감시 전용 프로토콜이 SNMP다.
- SNMP를 이용해서 감시할 수 있는 주요 내용
  - 네트워크 장비나 서버 가동 상태
  - 서비스 가동 상태
  - 시스템 리소스
  - 네트워크 트래픽

### 콘텐츠 감시

- 콘텐츠 감시는 웹 화면이 정상적으로 보여지는지 확인하기 위한 웹 시스템 특유의 감시다.
- 일반적으로 콘텐츠 감시는 부하분산 장치가 담당한다.
- 부하분산 장치에 감시 대상 URL을 등록해두고 HTTP의 GET 요청을 해서 정상적으로 응답이 있으면 해당 웹 서버 또는 웹, AP 서버가 정상
가동되고 있다고 판단한다.
- 응답이 오지 않으면 장애가 있다고 판단해서 부하분산 장치가 해당 웹 서버에는 요청을 할당하지 않는다.

--------------

## 백업

### 백업이란?

- 장애 대책을 생각할 때 이중화 등을 도입해서 서비스를 지속하는 것도 중요하지만, 만일의 경우에 대비해서 백업을 만들어 두는 것도
매우 중요하다.
- 이중화와 크게 다른 점은 데이터를 복제해서 별도 장소에 보관한다는 것이다.
- 백업은 데이터를 복제해 두기만 한다고 괜찮은 것이 아닌 백업 취득 빈도나 시점은 복원을 고려해서 계호기을 세워야 한다
- RTO(Recovery Time Objective)
  - 복구 목표 시간
  - 복구에 어느 정도 시간이 걸리나?
- RPO(Recovery Point Objective)
  - 복구 기준 시점
  - 어느 시점으로 복구할 것인가?

### 시스템 백업

- 시스템 백업은 OS나 미들웨어 등 일반 서버의 로컬 디스크 영역을 백업하는 것이다.
- OS나 미들웨어는 한번 설치해서 설정이 끝난 후에는 많은 변경이 발생하지 않기 때문에 백업 빈도는 데이터에 비해 적은 편이다.
- 시스템 백업 시점
  - 초기 구축 후
  - 일괄 처리 적용 시
  - 대규모 구성 변경 시

### 데이터 백업

- 매일 변경되는 데이터가 손실되지 않도록 하는 것으로 취득 빈도가 높다.
- 정지하기 힘든 시스템은 서비스가 가동 중인 상태라도 백업이 가능한 구조가 필요하다.

