# 3계층형 시스템을 살펴보자

-------------------------

## 3계층형 시스템의 구성도

- 세 대의 서버는 스위치를 경유해서 연결돼 있다.
- 각각의 서버는 하드웨어 부품들이 있다.
- 서버의 논리 구성은 각각 다르다

-----------------------

## 주요 개념 설명

### 프로세스와 스레드

- 프로세스 및 스레드는 프로그램 실행 파일 자체가 아니라 OS상에서 실행돼서 어느 정도 독립성을 가지고 동작하는 것이다.
- 대부분 '사람 모양'으로 표현하고 있듯이 프로세스나 스레드가 시작되는 것은 마치 사람이 숨을 쉬기 시작하면서 활동하는 것과 같은 의미다.
- 프로세스 및 스레드가 활동하려면 메모리 공간이 필요한데 이것은 커널에 의해 메모리상에 확보된다.
- 다양한 처리를 하면서 데이터를 주고받기 위해 이 공간을 사용하며 프로세스 시작 시에 이 공간이 확보된다.
- 프로세스 시작 시에 발생하는 일
  1. 프로그램은 서버 내부의 디스크상에 설치됨
  2. 시작 의뢰가 있으면 커널이 프로세스를 작성함. 또한 요청 분량만큼의 메모리 공간을 할당함.
  3. OS상에서 프로세스가 시작돼서 사용자 요청을 받을 수 있게 됨.
- 프로세스와 스레드의 메모리 공간 차이
  - 메모리 공간을 가지는 것이 '프로세스'.
  - 스레드는 메모리 공간을 공유하고 있다.
    - 스레드 시작 시에 신규 메모리 공간은 필요 없지만 다른 스레드에 이상이 발생하면 영향을 받는다.

- 프로세스 장점
  - 개별 처리 독립성이 높다
- 프로세스 단점
  - 생성 시 CPU 부하가 높다
- 스레드 장점
  - 생성 시 부하가 낮다
- 스레드 단점
  - 메모리 공간을 공유하기 때문에 의도하지 않은 데이터 읽기/쓰기가 발생할 수 있다.
- 프로세스도 메모리 공간을 공유할 수는 있다. 보통 캐시로 저장하고 있는 데이터를 공유 메모리 상에 두고 단독으로 이용하는 데이터는
전용 메모리에 둔다

### OS 커널

- OS 처리는 원칙적으로는 커널을 통해 이루어진다.
- 커널의 역할
  - 시스템 콜 인터페이스
    - 프로세스나 스레드로부터 명령을 받는 인터페이스
    - 키보드나 마우스 입력은 끼어들기로 처리된다
  - 프로세스 관리
    - 가동되고 있는 프로세스 관리와 CPU 이용 우선순위 등을 '스케줄'한다
  - 메모리 관리
    - 서버상의 메모리를 단위 크기(ex 4KB)의 블록으로 분할해서 프로세스에 할당한다
  - 네트워크 스택
    - 네트워크를 관리한다
  - 파일 시스템 관리
    - 파일 시스템을 관리한다
  - 장치 드라이버
    - 디스크, NIC, HBA 등의 물리 장치와 작업

1. 시스템 콜 인터페이스

- 프로세스/스레드에서 커널로 연결되는 인터페이스.
- 애플리케이션이 OS를 통해서 어떤 처리를 하고 싶으면 시스템 콜이라고 하는 명령을 이용해 커널에 명령을 내리고, 이 명령이 인터페이스를 통해서 전달됨.
  - 은행이나 구청 등의 접수 창구와 비슷함

2. 프로세스 관리

- OS상에서는 수십, 수백, 수천 개의 프로세스를 가동할 수 있지만 물리 서버의 CPU 코어 수는 많아야 수십 개 정도밖에 안 된다.
- 언제, 어떤 프로세스가 어느 정도의 CPU 코어를 이용할 수 있는지, 처리 우선순위를 어떻게 결정할 것인지 등을 관리.
- 이 기능이 없으면 OS가 성립되지 않기 때문에 OS에 있어 가장 중요한 기능이라 할 수 있다.

3. 메모리 관리

- 프로세스 관리는 CPU 코어를 고려했지만, 메모리 관리에서는 물리 메모리 공간의 최대치를 고려한다.
- 프로세스가 이용하는 독립 메모리 공간을 확보하거나 상호 간의 참조 영역을 지키기 위해 독립성을 관리하는 등의 메모리 관리 역할을 한다.
- 이 기능이 없으면 각 프로세스는 자신 이외의 프로세스가 사용하고 있는 메모리 영역 범위를 파악해야 하므로 애플리케이션 개발이 매우 어렵다.

4. 네트워크 스택

- 6장

5. 파일 시스템 관리

- 파일 시스템용 인터페이스를 제공한다.
- 파일 시스템은 OS 기능의 하나로서 물리 디스크에 제공된 데이터를 관리하는 기능이다.
- 물리 디스크에 기록된 데이터는 단순히 0과 1의 숫자의 집합에 불과하다. 심지어 구분 표시도 없다.
- 파일 시스템 덕분에 애플리케이션은 파일 이라는 단위로 데이터를 작성하거나 삭제할 수 있다.

6. 장치 드라이버

- 디스크나 NIC 등의 물리 장치용 인터페이스를 제공한다.
- 디스크나 NIC 등은 다양한 제조사들이 있기 때문에 각 장치 제조사가 OS에 대응하는 장치 드라이버를 제공해서 해당 OS의 표준 장치로서 커널을
경유해 이용할 수 있게 하는 것이다.


------------------------------

## 웹 데이터 흐름

### 클라이언트 PC부터 웹 서버까지

1. 웹 브라우저가 특정 인터넷 사이트에 요청을 보낸다.
2. 해당 사이트가 어디에 있는지 이름 해석을 한 후 이 결과를 가지고 해당하는 웹 서버에 요청을 보낸다.
3. 웹 서버의 httpd 프로세스가 요청을 접수한다.
4. httpd가 받은 요청 내용을 분석해서 정적인 내용인지 동적인 내용인지를 판단한다.
5. 정적인 정보는 디스크로부터 읽고, 동적인 정보는 네트워크를 경유해서 다른 서버에 요청을 보낸다.


#### 클라이언트 PC에서 웹 브라우저 실행

1. 웹 브라우저가 OS의 프로세스로 실행된다.
2. 프로그램은 원래 디스크에 저장돼 있기 때문에 OS가 읽어서 메모리에 상주시키고 실행한다.
3. 웹 브라우저 화면에서 링크를 클릭하면 웹 서버로 요청을 보낸다.
4. 이 요청은 OS의 시스템 콜로 실행되고, 커널을 통해 NIC에 네트워크 통신이 요청된다.
5. 네트워크 경유로 웹 서버에 요청한다.

#### 이름 해석 구조

1. 웹 브라우저는 'jpub.kr'등의 도메인 IP 주소를 모른다.
2. OS의 호스트명, IP 주소 변환 테이블을 참조해서 존재하지 않는 경우, 외부의 DNS 서버에 요청을 던진다.
3. 전 세계에 있는 DNS 서버는 Root DNS를 기준으로 트리 구조로 돼있으며 개별 DNS 서버는 정기적으로 부모 DNS 서버에서 데이터를 받아
최신 IP 주소 목록을 유지한다.
4. IP 주소 검색 결과가 반환된다.

### 웹 서버부터 AP 서버까지

- 동적 컨텐츠에 대한 요청을 처리하는 것이 AP 서버다.

1. 웹 서버로부터 요청이 도착한다. 웹 서버로부터 온 요청은 NIC를 경유해서 커널에 의해 인터럽트 처리된다.
2. 스레드가 요청을 받으면 자신이 계산할 수 있는지, 아니면 DB 접속이 필요한지를 판단한다.
3. DB 접속이 필요하면 연결 풀에 액세스한다. 접속 요청도 시스템콜을 사용한다.
4. DB 서버에 요청을 던진다.(네트워크 경유)

- AP 서버가 DB 서버에 접속하려면 '드라이버'가 필요하다. 드라이버 뒷단에 있는 것이 데이터베이스로 가는 인터페이스로, 해당 데이터베이스 자체를
은폐하는 역할을 한다.

#### DB 서버 이외의 옵션

- 데이터가 필요하면 DB 서버에 접속하는 것이 일반적이지만 '대한민국 행정 경계 정보'와 같이 자주 바뀌는 데이터가 아닌것들은 매번 데이터베이스에
질의할 필요가 없다. 이렇게 규모가 작고 갱신 빈도가 낮은 정보는 JVM내에 캐시 혹은 캐시 전용 서버에서 처리하도록 한다.
- 반대로 규모가 큰 정적 데이터 전송 시에는 DB 서버 이외에 CDN(Content Delivery Network)이라 불리는 데이터 전송 전용 서버를 이용하는 경우도 있다.

### AP 서버부터 DB 서버까지

1. DB 서버에서는 DB 프로세스가 요청을 접수한다
2. 이전에 사용한 정보는 캐시에 있기 때문에 이 정보를 찾기 위해 일단 공유 메모리를 검색한다.
3. 공유 메모리에 데이터가 존재하지 않으면 디스크에서 읽는다.(시스템 콜을 경유해 디스크에 요청을 던짐)
4. 디스크의 데이터는 요청을 보낸 프로세스로 반환됨
5. 한번 액세스한 데이터는 메모리에 캐시 형태로 저장되고 이후 액세스 시에 재사용됨.
6. 요청을 보낸 AP 서버로 데이터를 반환

- 웹 서버에서는 개별 프로세스가 독립된 형태로 동작하지만 DB 서버에서는 여러 개의 프로세스가 역할을 분담하는 경우가 있다.
- 요청을 SQL로 받아서 해석하거나 데이터에 엑세스하는 프로세스가 있고, 메모리에 캐시로 존재하는 데이터와 디스크에 있는 데이터를 정기적으로 동기화하는 프로세스도 있다.
  - 분업을 통해 처리를 병렬화해서 처리량을 향상시킨다.

### AP 서버부터 웹 서버까지

1. DB 서버로부터 돌아온 데이터는 NIC 경유로 원래 스레드에 반환된다
2. DB 데이터, JVM의 캐시 데이터 등을 이용해서 계산 처리, 집계 처리 등이 이루어지고 특정 형태의 파일이 생성된다.
3. 결과를 웹 서버로 반환한다

- 가공 결과가 텍스트 데이터라면 HTML이나 XML파일, 동적 이미지 등의 바이너리 데이터를 생성해서 반환하는 경우도 있다.
- HTTP로 전송 가능한 데이터라면 어떤 형태의 데이터든지 상관없다.

### 웹 서버부터 클라이언트 PC 까지

1. AP 서버에서 돌아온 데이터는 NIC 경유로 원래 스레드에 반환된다
2. 필요한 데이터 가공은 모두 AP 서버에서 이루어지기 때문에 그대로 웹 브라우저에 데이터를 반환한다.
3. 요청한 데이터를 웹 브라우저로 반환한다

--------------------------

## 가상화

### 가상화란?

-  가상화란 컴퓨터 시스템에서 물리 리소스를 추상화하는 것이다.

### OS도 가상화 기술의 하나

- 하드웨어를 의식하지 않고 애플리케이션을 실행할 수 있는 운영체제는 가상화 기술 중 하나라고 볼 수 있다.
- OS의 커널에 의해 하드웨어가 추상화되면서, 컴퓨터에 연결된 기억 장치나 네트워크를 통한 데이터 교환이 하드웨어를 의식하지 않고 이루어지고 있다.

### '가상'과 '버추얼'의 차이

- Virtual(버추얼)은 사실에 가까운, 엄밀하게는 다르지만, 사실상의~
- 가상은 실물이 아닌
- 컴퓨터에서 가상이라는 용어가 나오면 실제가 아닌 이 아니라 물리적으로 존재하지 않지만 실제로 조냊하는 것과 같다는 긍정적 의미를 떠올리는 것이
이해가 쉽다.

### 가상 머신

- 호스트 OS형
  - 윈도우나 리눅스 등의 호스트 OS상에 가사오하 소프트웨어를 설치해서 이용하는 것
  - Vmware Server, Microsoft Virtual Server
  - 소프트웨어를 에뮬레이터하는 것으로 성능면에 제한이 있음.
- 하이퍼바이저형
  - 하드웨어상에서 직접 가상화 소프트웨어를 실행하고 그 위에 가상 머신을 동작시키는 기술
  - Vmware vSphere, Hyper-V, Xen, KVM
  - 호스트 OS를 거치지 않으므로 호스트형보다 성능이 우수해 서버 가상화의 대표 기술

- 하이퍼바이저형 가상화 구조
  - 완전 가상화
    - 물리 머신상에서 동작하는 OS나 드라이버를 그대로 게스트로 이용할 수 있음.
    - 소프트웨어로 에뮬레이션하기 때문에 성능이 저하됨
  - 준 가상화
    - 실존하는 하드웨어를 에뮬레이션하는 것이 아닌 가상 환경용 가상 하드웨어를 소프트웨어적으로 에뮬레이션함.
  - 가상 환경에서 동작시키는 게스트 OS마다 준가상화 전용 드라이버나 준가상화용으로 최적화된 OS 커널을 이용해야 했었으나 
  인텔이나 AMD 등의 프로세서 제조사가 가상 하드웨어 지원 기능을 개발해서 하이퍼바이저도 지원하게 되면서 완전 가상화가 자리를 잡음

### 컨테이너의 역사

- 컨테이너는 '그릇','용기' 등의 의미로 리소스가 격리된 프로세스다.
- 각 컨테이너가 커널 공간을 공유한다.
- 하나의 OS상에서 여러 개를 동시에 가동할 수 있으며, 각각 독립된 루트 파일 시스템, CPU/메모리, 프로세스 공간 등을 사용할 수 있다는 점이
하드웨어 가상화인 가상 머신(VM)과의 차이다.

### 도커의 등장

- 도커는 2008년에 언어에 의존하지 않는 PaaS(Platform as a Service)를 구축하기 위해 설립됐다.(설립명은 닷클라우드)
- 개발한 애플리케이션을 클라우드에 배포해서 실행하는 구조였으나 애플리케이션 관련 프레임워크나 라이브러리 등의 버전이 일치하지 않아서 로컬에서 실행된
프로그램이 클라우드에서는 실행되지 않는 문제가 빈번히 발생했다.
- 따라서 원래 클라우드 내부 구조로 개발했던 애플리케이션 실행 환경을 자동 구축해주는 '도커 이미지'라는 기술을 클라우드 이외의 환경에서도 사용할 수 있게
오픈 소스로 공개하고, 도커 허브(Docker Hub)라는 도커 이미지를 공유할 수 있는 레지스트리가 생겨나면서 폭발적인 인기를 얻기 시작했다.
- 도커의 장점
  - 컨테이너는 호스트 OS와 커널을 공유하므로 컨테이너 실행이나 정지 속도가 빠르다
  - 호스트 OS의 커널을 공유하므로 VM만 사용하는 경우와 비교해 한 대의 호스트 머신상에서 훨씬 많은 컨테이너를 실행할 수 있고 이를 통해 리소스를
  한 곳에서 쉽게 관리할 수 있다.
  - 도커는 라이브러리나 프레임워크 등을 도커 이미지로 묶어서 공유할 수 있는 것으로 특정 환경에서는 재현되지만 자신의 개발 환경에서는 재현되지 않는 문제가
  발생하기 어렵기에 버그를 효율적으로 수정할 수 있다.

### 클라우드와 가상화 기술

- 하이퍼바이저 및 컨테이너 등의 가상화 기술은 구글이나 페이스북, 아마존 등의 대규모 웹 서비스에서 사용되고 있다.
- AWS, GCP, Azure