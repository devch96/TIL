# 인프라를 지탱하는 응용 이론

--------------------

## 캐시

### 캐시란

- cash(현금)이 아닌 cache(숨기는 장소)
- 컴퓨터 세계에서 캐시는 사용 빈도가 높은 데이터를 고속으로 액세스할 수 있는 위치에 두는 것을 의미한다.
- CPU의 1차 캐시나 2차 캐시, 저장소 캐시, OS 페이지 캐시, 데이터베이스 버퍼 캐시 등 광범위하게 캐시 기술이 사용되고 있다.
- 캐시는 임시 저장소를 의미한다.
- 캐시의 특징
  - 일부 데이터를 데이터 출력 위치와 가까운 지점에 일시적으로 저장한다
  - 데이터 재사용을 전제로 한다

### 어디에 사용되나?

- 브라우저 캐시는 웹 브라우저가 접속한 페이지를 캐시하여 웹 서버 접속을 줄이고 브라우저 표시를 고속화한다.
  1. 브라우저는 요청된 페이지가 캐시돼 있는지 확인.
  2. 존재하지 않으면 웹 서버에 요청
  3. 페이지를 저장한 후 브라우저에 표시
- 웹 서버 자체 부하를 줄이는 다른 방법으로는 웹 서버와 클라이언트 사이에 캐시 서버를 배치하는 방법이 있다.
  - 요즘에는 캐시 서버를 앞에 두는 대신에 CDN(Content Delivery Network)라는 다른 네트워크에 웹 컨텐츠 캐시를 배치하는 구조를 이용하기도 한다.
  1. 클라이언트는 웹 서버에 접속하기 위해 DNS에 질의
  2. DNS 서버는 웹 서버가 아닌 캐시 서버 한 대의 IP 주소를 반환.
  3. 캐시 서버에 컨텐츠가 있으면 캐시 서버에서 컨텐츠를 반환
  4. 캐시 서버에 없으면 웹 서버에서 취득

### 정리

- 캐시의 장점
  - 데이터에 고속으로 액세스 할 수 있다.
  - 실제 데이터에 대한 액세스 부하를 줄일 수 있다.
- 캐시에 적합한 시스템
  - 참조 빈도가 높은 데이터
    - 몇 번이고 같은 데이터를 참조한다면 캐시에 배치해서 고속으로 데이터에 액세스할 수 있다.
  - 캐시의 데이터가 손실돼도 문제가 없는 시스템
    - 스트리밍 데이터 등은 갱신이 없기 때문에 캐시에 장애가 발생해도 원 데이터를 다시 캐시에 배치하기만 하면 복원이 가능함.
    - 읽기 전용 데이터에 적합
- 캐시에 부적합한 시스템
  - 데이터 갱신 빈도가 높은 시스템
    - 데이터 갱신이 빈번하게 발생하는 경우는 갱신 시마다 캐시해야 해서 바로 액세스하는 경우와 차이가 없음.
  - 대량의 데이터에 액세스하는 시스템
    - 큰 데이터를 참조하는 경우 캐시 크기도 커지며 캐시에 배치하기까지도 많은 시간이 걸린다.
    - 분석 시스템에서는 캐시에 데이터를 두는 것은 적합하지 않다.
- 캐시의 주의할점
  - 데이터가 실제 데이터와 캐시라는 이중 구조로 저장되기 때문에 리소스 소비가 늘어난다. 어떤 데이터를 캐시하는 것이 효과적인지 검토해야 한다.
  - 시스템 가동 직후 등에는 캐시에 데이터가 없기 때문에 원하는 성능이 나오지 않을 수 있다.
  - 캐시 계층이 늘어나기 때문에 시스템 성능 문제나 데이터 불일치 문제가 발생한 경우는 문제 발생을 야기한 용의자가 늘어난다.
  - 캐시의 데이터가 손실되는 경우를 대비해서 복구 숫ㄴ서를 설계 시에 확립해야 한다.
  - 갱신 데이터를 캐시할 때 캐시가 여러 개 있으면 갱신된 최신 데이터를 서로 뺏으려는 상태가 발생하지 않도록 주의해야 한다.

---------------------------

## 끼어들기

### 끼어들기란?

- 어떤 원인으로 인해 지금 하고 있는 일을 중단하고 급히 다른 일을 하는 것을 끼어들기(인터럽트)라고 한다.
- 급한 일을 먼저 하도록 CPU에 알리는 중요한 역할

### 자세히 보자

- CPU에서 애플리케이션 프로세스나 스레드 처리를 하고 있더라도 키보드로 정보가 입력되면 I/O 컨트롤러가 CPU에게 
키보드가 입력됬다고 연락하고 끼어들기가 발생해서 CPU가 짧은 순간 다른 처리를 한 후 다시 원래 처리를 진행한다.
- 끼어들기 종류
  - 정기적으로 해야 할 일을 알려주는 타이머
  - 데이터를 메모리에 모두 읽었다는 것을 CPU에게 알려줌
  - 현재 동작 중인 프로그램에 중대한 에러가 발생했을 때 프로세스를 정지시키는 예외 처리 등

### 어디에 사용되나?

1. 브라우저가 웹 사이트에 접속하면 서버의 NIC에 이더넷 프레임이 도착.
2. 이더넷 프레임이 도착하면 NIC를 통해 CPU에 끼어들기가 발생하고, CPU를 사용하고 있던 프로세스 정보가 메모리에 저장된 후 일시적으로 CPU를 빼내서
데이터를 수신
3. 끝나면 중단했던 프로세스 처리가 재개.

### 정리

- 끼어들기는 어떤 일이 발생하면 연락하는 '이벤트 주도'구조다.

-----------------------

## 폴링

### 폴링이란?

- 폴링(Polling)은 정기적으로 질의하는 것을 가리킨다.
- 정기적으로 질의함으로써 상대가 어떤 상태인지, 어떤 요구를 가지고 있는지 등을 알 수 있다.
- 폴링의 특징
  - 질의 방향이 단방향이다
  - 질의는 일정 간격을 따라 정기적으로 발생한다
- 폴링의 장점
  - 반복(루프)만 하면 되기에 프로그래밍이 쉽다
  - 상대가 응답하는지 확인할 수 있다
  - 모아서 일괄적으로 처리할 수 있다

### 어디에 사용되나?

- 시간 동기 처리
- 어플리케이션 알람 등

### 정리

- 폴링의 적합한 처리
  - 일정 간격으로 처리를 실행하면 좋은 처리
    - 일련의 처리를 할 때 전처리와 후처리가 연계되지 않는 경우에 적합
  - 감시
    - 시스템 컴포넌트가 다운되거나 멈춰 있는 경우에 컴포넌트가 자발적으로 상태를 전달 할 수 없다.
    - 외부에서 정기적으로 상태를 확인해야지 컴포넌트 상태를 알 수 있다.
- 폴링의 부적합한 처리
  - 상태가 아닌 입력 내용에 따라 실행 내용을 변경하는 처리
  - 처리 우선순위를 정해야 하는 처리
- 폴링의 주의 사항
  - 네트워크를 경유한 폴링일 때는 처리 지연 시간을 줄이기 위해 폴링 간격을 너무 짧게 잡으면 트래픽 양이 증가하므로 주의가 필요.
  - 서버의 리소스 소비도 늘어남

------------------------

## I/O 크기

### I/O 크기란?

- I/O 크기란 1회의 I/O에 필요한 사이즈, 즉 데이터를 주고 받을 때 사용되는 I/O의 크기를 의미한다.
- I/O 크기의 특징
  - 물건(데이터)를 운반할 때는 상자에 넣으면 효율적으로 관리할 수 있다.
  - 운반하는 양에 따라 상자 크기를 선택하면 효율적으로 운반할 수 있다.

### 어디에 사용되나?

#### 오라클 DB 예

- 오라클 DB가 데이터 파일을 읽기/쓰기 하는 최소 단위를 데이터 블록이라고 하고, 그 크기를 블록 크기라고 한다.
- 블록 크기가 8KB라면 1바이트 데이터를 읽어도 8KB를 읽는다.
- I/O 크기가 작을 때는 블록 크기를 작게, I/O 크기가 클 때는 블록 크기를 크게 해야 I/O 효율이 좋아진다.
- DB 뿐만 아니라 아래 계층도 의식해야 할 필요가 있다.
  - 데이터베이스 블록 크기가 OS 블록 크기와 다르면 데이터베이스 블록 크기가 OS 블록 크기의 배수가 되게 설정해야 한다.
  - 데이터베이스 블록 크기가 8KB, OS 블록 크기(파일시스템)가 7KB이라면 DB에서 1블록 읽어도 OS는 2블록 읽어야 한다.
  - 데이터베이스 블록 크기가 4KB, OS 블록 크기가 8KB라면 DB에서 1블록만 읽고 싶어도 파일에서 8KB를 읽어야 한다.
  - DB가 8KB, OS가 4KB(배수) 라면 효율적으로 가져올 수 있다.

#### 네트워크 예

- 브라우저로 인터넷에 있는 웹 사이트를 볼 때 PC 내 메모리에 있는 데이터가 NIC를 통해서 밖으로 나오고, 스위치나 라우터를 경유해서
웹 서버에 도착한다. 이때 데이터는 상자에 든 채 운반된다.
- 웹 브라우저가 데이터를 전송할 때는 OS의 소켓이라는 구조를 사용한다. 웹 브라우저는 OS에 의뢰해서 소켓을 만들어 통신한다. 소켓을 작성하면
소켓 버퍼(송신, 수신 버퍼)라는 상자가 만들어지고, 이 버퍼가 차면 OS에 의해 TCP 세그먼트라는 상자로 분할되고, TCP 헤더, IP 헤더, MAC 헤더라는 편지 수신자 같은 정보를 붙여서 이더넷 프레임이라는 상자에 넣어 전송한다.
- 송신 버퍼가 TCP 세그먼트로 분할될 때 MSS(Maximum Segment Size)를 초과하지 않는 범위에서 분할된다.
- IP 소켓의 최대 크기를 MTU(Maximum Transfer Unit)라고 한다.
- 입출력 시에 MTU 크기가 같다면 그대로 송신되지만, 경로 도중에 있는 라우터의 MTU 크기가 작게 설정돼 있으면 웹 서버가 송신하는 패킷이
경로 도중에 더 작게 불할돼서 오버헤드가 발생하고 이는 성능 저하로 연결될 수 있다.

### 정리

- 큰 상자는 대량의 데이터를 빠르게 운반할 수 있으며(처리량 중시), 작은 상자는 소량의 데이터를 빠르게 운반할 수 있다(지연 시간 중시)

---------------------

## 저널링

### 저널링이란?

- 저널(journal)은 트랜잭션이나 매일 갱신되는 데이터의 변경 이력을 가리킨다.
- 저널을 남겨 두는 것을 저널링이라고 한다.
- 저널링은 언제, 어디서, 무엇을 했는지 상세하게 기록해서 시스템 장애가 발생했을때 어디까지 정상 처리됐는지, 그리고 어디부터 재실행하면 좋을지 알 수 있게 하는 기능이다.
- 저널의 특징
  - 데이터 자체가 아닌 처리(트랜잭션) 내용을 기록한다.
  - 데이터 일관성이나 일치성이 확보되면 필요 없어진다.
  - 데이터 복구 시 롤백(Rollback), 롤포워드(Rollforward)에 이용된다.

### 어디에 사용되나?

#### 리눅스의 ext3 파일 시스템

- ext3 파일 시스템은 저널링 기능을 갖추고 있으며, 파일I/O도 트랜잭션으로 간주된다.

#### 오라클 DB

- 오라클 DB의 저널은 REDO 로그라 불린다.
- 트랜잭션 종료 시(커밋 시)에 버퍼가 디스크에 기록되지만, 기록 중인 REDO 로그가 파손된 경우에는 데이터를 최신 상태로 복원할 수 없다.
- 이때문에 오라클 DB는 Redo 로그를 이중화해서 보호한다.(이중화된 로그를 멤버(Member)라고 한다)

### 정리

- 저널링의 장점
  - 시스템 장애 시 복구가 빠르다
  - 데이터 복제보다도 적은 리소스를 소비해서 데이터를 보호할 수 있다.
- 저널링이 적합한 시스템
  - 데이터 갱신이 발생하는 시스템
    - 트랜잭션 내용을 기록해 둠으로써 데이터 안정성을 높일 수 있다.
- 저널링이 부적합한 시스템
  - 데이터 안정성보다 성능을 요구하는 시스템
    - 저널링을 하면 기록 처리 시 오버헤드가 발생하기 때문에 성능을 중시하는 시스템이라면 이 오버헤드를 줄일 방법을 검토해야 한다.
- 저널을 사용한 복구
  - 롤백
    - 저널을 읽어서 실제 데이터 정보를 과거로 되돌리는 처리
  - 롤포워드
    - 저널을 읽어서 실제 데이터 정보를 앞으로 진행시키는 처리
- 저널링의 주의점
  - 저널 데이터는 메모리의 버퍼에 일단 저장되기 때문에 디스크에 기록되지 않으면 장애 시 잃을 수 있다.
    - 시스템의 요건에 따라 버퍼의 디스크 기록 시점을 검토, 조정해야 한다.
    - 기록 빈도가 많으면 오버헤드도 높아지기 때문에 절충해서 검토해야 한다.
  - 저널은 트랜잭션 단위로 일치성을 보증하기 때문에 트랜잭션 도중에 장애가 발생하면 종료되지 않은 트랜잭션은 파괴된다.
    - 하나의 트랜잭션 단위가 크면 트랜잭션 도중 장애가 발생할 가능성이 높기 때문에 길어지지 않게 설계해야 한다.

-----------------------

## 복제

### 복제란?

- 복제(Replication)는 DB나 저장소 등에서 자주 사용되는 기술이다.
- 각종 재해에 대비해서 멀리 떨어진 장소에 데이터 센터를 구축해서 예비 시스템에 데이터를 복제하거나 웹 서비스에서 대량의 사용자 접속에 대비해서 동일
데이터를 여러 서버에 복제해서 부하분산을 하기도 한다.
- 복제의 특징
  - 장애 시 데이터 손실을 예방할 수 있다.
  - 복제를 이용한 부하분산이 가능하다.

### 어디에 사용되나?

- 저장소 복제
  - 저장소 제조사별로 조금씩 구조가 다르지만 블록 단위로 증감 데이터만 복제 위치에 반영해서 데이터 전송량을 줄인다.
  - 데이터 보호를 최우선으로 할 때는 쓰기 처리 시 데이터가 복제되기까지 기다리는 모드가 있다.
- MySQL 복제
  - 데이터 '추가, 갱신, 삭제'등의 변경 처리(트랜잭션)를 복제 측으로 보낸다.
  - 실제 데이터 블록을 전송하는 것이 아니기 때문에 복제 데이터 전송량을 줄일 수 있다.
  - 복제를 통해 데이터의 최종 복사본이 다른 곳에 생성되며, 캐시처럼 사용하거나 부하분산에 사용할 수 있다.

### 정리

- 복제에 적합한 시스템
  - 데이터 손실을 허용하지 않고 장애 시 복구 속도가 빨라야 하는 시스템
    - 실제 데이터에 장애가 발생한 경우에 바로 복제 위치로 변경해서 서비스를 계속해야 하는 시스템
  - 데이터 참조와 갱신 부분이 나뉘어져 있으며 참조가 많은 시스템
    - 데이터 갱신용 서버가 한 대 있고 복제 위치 서버는 참조용으로만 사용하는 경우 복제 위치 서버를
    여러 대 구축해서 부하를 분산하고 확장성을 향상시킬 수 있음.
- 복제에 부적합한 시스템
  - 데이터 갱신이 많은 시스템
    - 복제 대상 데이터가 많아져 오버헤드가 높아짐.
    - 경합 위험을 줄이기 위해 갱신은 한 곳에서 하는 것이 바람직함
- 복제 주의점
  - 복제 위치가 많으면 갱신이 많은 시스템과 같이 복제 오버헤드가 높아짐
  - 실제 데이터와 복제 데이터를 완전히 일치시키고 싶으면 쓰기 완료 처리를 보장해야 하는데 시스템 응답이 악화될 수 있음.
  - 시스템 유지관리나 장애 시에는 복제 데이터도 고려해야 하므로 설계나 운용 난이도가 높아짐
  - 복제 데이터와 실제 데이터의 차이가 커지면 그 차이를 채우기 위한 시간이나 성능도 고려해야 함

---------------------

## 마스터-워커

### 마스터-워커란?

- 마스터-워커(Master-Worker)는 주종 관계를 가리킨다.
- 명령하는 쪽과 명령을 받는 쪽의 관계라 할 수 있다.
- 이 구조에서는 한 명이 관리자가 돼서 다른 모든 것을 제어하게 된다.
- 마스터-워커의 특징
  - 상호 접속 관계의 일종으로 한 쪽이 관리자가 돼서 모든 것을 제어한다
  - 마스터-워커의 반대가 피어 투 피어다

### 어디에 사용되나?

#### 오라클 Real Application Cluster(RAC)

- 마스터-워커와 피어 투 피어의 장점만 조합해서 이용하는 경우도 있다
- RAC에서는 여러 대의 물리 서버가 클러스터 구성으로 연결돼 있다.
- 특정 서버가 마스터가 되는 것이 아니라 모ㅜ가 대등한 관계라서 특정 서버가 다운돼도 데이터베이스 전체 가용성에는 영향을 주지 않는다.(피어 투 피어)

### 정리

- 마스터-워커의 장점
  - 관리자가 한 명이기 때문에 구현이 쉽다
  - 워커 간 처리를 동기화할 필요가 없기 때문에 통신량이 줄어든다
- 마스터-워커의 단점
  - 마스터가 없어지면 관리를 할 수 없다(작업 인계 구조가 필요)
  - 마스터의 부하가 높아진다

--------------------

## 압축

### 압축이란?

- 디지털 데이터는 압축할 수 있다.
- 압축은 쓸데없는 공간을 줄이기 위해 사용한다

### 자세히 보자

- 디지털 데이터에서 교환하는 것은 정보이므로 정보의 낭비를 막으면 압축을 할 수 있다.
- 낭비되는 정보란 필요 없는 정보 혹은 이미 알고 있는 정보다.
- 디지털 압축의 기본은 '중복 패턴 인식'과 그것을'변경'하는 것이다.
- 최종적으로 디지털 데이터는 이진수라는 공통 단위로 표현되기 때문에 그것이 이미지이든 문자열이든 동일한 방법으로 압축할 수 있다.
- zip 압축처럼 빈도가 높은 패턴을 우선적으로 찾아서 변경하는 방식에는 데이터 전체를 한번 읽어야 해서
시간이 걸린다.
- 압축의 장점은 데이터 크기를 줄이는 것이고 단점은 처리 시간이 걸린다는 것(데이터 크기와 시간이 상충)이기에 자주 변겨오디지 않는 데이터에 효과적이다.
- 네트워크 경유의 데이터 전송 등 I/O 속도가 느린 환경에서는 미리 압축해서 전송하면 전체적인 처리 시간을 줄일 수 있다.

#### 가역 압축과 비가역 압축

- 가역 압축
  - 원래 상태로 복구할 수 있다.
  - 이미 알고 있는 정보를 제거하는 압축 방식
- 비가역 압축
  - 원래 상태로 복구할 수 없는 대신에 압축률이 높다
  - 자신에게 필요 없는 정보를 제거 즉 최소 필요 정보만 남겨두는 압축 방식
  - 음성이나 이미지 데이터에 있는 사람이 인식할 수 없는 부분을 생략하는 예

### 어디에 사용되나?

- 거의 모든 곳에서 사용되고 있는 기술
- 데이터 압축은 압축률을 높이면 옾일수록 처리 시간이 오래 걸리기 때문에 사용 위치에 따라서 적절한 압축 방법을 선택해야 한다.
  - jar, war도 zip 형식 압축 파일
  - .docx, .pptx도 zip으로 압축돼 있다

### 정리

- 압축은 불필요한 공간을 제거해서 데이터 크기를 줄이는 기술
- 크기를 작게 해서 데이터 처리나 교환 시 오버헤드를 줄일 수 있다는 장점이 있지만, 압축/해제 처리로 인해 리소스 부하가 높아지거나
처리 시간이 증가한다는 단점도 있다.

--------------------

## 오류 검출

### 오류 검출이란?

- 의도하지 않은 때에 데이터가 망가질 수 있기 때문에 이것을 방지하기 위해 오류 검출이라 불리는 구조가 있다.

### 자세히 보자

- 디지털 데이터에 오류가 생기는 이유에는 여러 가지가 있지만 예시 두가지
  - 통신 중에 데이터 파손
    - 대부분의 통신 방식에서는 전기 신호를 이요해서 데이터를 교환하고 있다.
    - 경로 도중 낙뢰로 전기적은 잡음 등이 발생하면 데이터가 파손될 수 있다.
  - 칩(chip)에서의 데이터 파손
    - 메모리의 데이터도 전기적으로 저장되기 때문에 통신 중인 데이터 파손처럼 전기적인 영향으로 값이 바뀌는 경우가 있다.

### 오류를 검출하려면

- 추가 정보가 없는 한 그것이 맞는지 틀린지 알 수 없다.
- 틀렸다는 것을 확인하려면 전송된 데이터와는 별도로 추가 정보가 필요하다.

#### 오류 검출

- 패리티 비트(Parity Bit)
  - 비트에서 반드시 1이라는 수가 짝수 개 또는 홀수 개가 되도록 1비트만 추가한다.
  - 패리티 비트를 설정한 단위의 1비트까지 데이터가 바뀌어도 1이 짝수 개인지 홀수 개인지 확인해서 오류를 검출할 수 있다.
  - 하지만 동시에 2비트를 바꿔버리면 짝수가 반환되기 때문에 오류를 인지할 수 없다.
- 오류 검출의 장점은 말 그대로 오류를 알 수 있다는 것이다. 수정까지는 하지 않더라도 오류를 검출하는 것은 중요하다.
- 단점은 추가 데이터를 부여해야 하므로 데이터 양이 증가하며, 오류 여부를 알기 위해 계산이 필요해 처리에 오버헤드가 발생한다

### 어디에 사용되나?

- CPU나 메모리 내부에서는 오류 검출 및 수정 기능을 가지고 있다.
- 네트워크 통신에서는 프로토콜에 따라 각 계층의 오류 검출용 구조를 갖추고 있다.
- TCP/IP 및 이더넷은 계청별로 체크섬이나 CRC 오류를 검출하는 구조를 도입하고 있다.
- 수신 측에서는 해당 프레임이나 패킷에 오류가 있다는 것을 감지하면 해당 데이터를 제외한다.

### 정리

- 오류 검출이란 데이터의 파손 여부를 확인하는 기법으로 파손된 경우에는 데이터를 다시 읽어 재처리할 수 있다.
