# 더 큰 단위 테스트 그림

----------

## 테스트 주도 개발

- 작성하려는 코드가 있다면 항상 먼저 어떻게 그 코드를 테스트할지 고민해야 함
  - 코드를 작성한 후에 어떻게 테스트할지 고민하기보다 작성할 코드를 묘사하는 테스트를 설계해야 함

### TDD의 주된 이익

- 코드가 예상한 대로 동작한다는 자신감을 얻는 것
- TDD를 잘 따른다면 구현하는 실질적인 모든 사례에 대해 단위 테스트를 작성하게 되고, 이러한 테스트들은 코드를 지속적으로 발전시킬 수 있는 자유를 줌

### 단순하게 시작

- 세 부분의 사이클로 구성됨
  - 실패하는 테스트 코드 작성하기
  - 테스트 통과시키기
  - 이전 두 단계에서 추가되거나 변경된 코드 개선하기
- 첫 번째 단계는 시스템에 추가하고자 하는 동작을 정의하는 테스트 코드를 작성하는 것

```java
public class ProfileTest {
    @Test
    public void matchesNothingWhenProfileEmpty() {
        new Profile();
    }
}
```

- Profile이란 클래스가 없으므로 생성해야 함
- 같은 방식으로 나머지 테스트를 작성함.
- IDE에서 오류가 발생하면 컴파일되는 수준으로만 코드를 작성하여 대응

```java
public class ProfileTest {
    @Test
    public void matchesNothingWhenProfileEmpty() {
        Profile profile = new Profile();
        Question question = new BooleanQuesttion(1, "Relocation package?");
        Criterion criterion = new Criterion(new Answer(question, Boolean.TRUE),
                Weight.DontCare);
        boolean result = profile.matches(criterion);
        
        assertFalse(result);
    }
}
```

- 테스트가 먼저 실패해야 기대하는 동작(테스트가 기술하는)이 아직 시스템에 존재하지 않다는 것을 알 수 있음

### 또 다른 증분 추가

- 실패하는 각 테스트에 대해 그 테스트를 통과할 수 있는 코드만 추가
  - 가능한 가장 작은 증가(increment)를 추가
- TDD 사이클에 따르는 좀 더 실용적인 관점에서 가장 작은 양의 코드를 작성하는 것은 대부분 먼저 실패하는 또 다른 테스트를 만들 수 있다는 의미

### 테스트 정리

- 테스트는 짧고 깔끔해야 함.
- 통과한 테스트는 다시 정리함

-------------

## 까다로운 테스트

### 멀티스레드 코드 테스트

- 동작하는 동시성 코드를 작성하는 것은 어려움
- 동시성 처리가 필요한 애플리케이션 코드를 테스트하는 것은 기술적으로 단위 테스트의 영역이 아님
  - 통합 테스트로 분류하는 것이 나음

#### 단순하고 똑똑하게 유지

- 스레드 통제와 애플리케이션 코드 사이의 중첩을 최소화
  - 스레드 없이 다량의 애플리케이션 코드를 단위 테스트할 수 있도록 설계를 변경
- 다른 사람의 작업을 믿음
  - 훌륭한 동시성 유틸리티 클래스(java.util.concurrent)
  - 직접 코딩하지말고 사용하라

### 데이터베이스 테스트

- JPA 인터페이스를 구현하는 코드에 대한 단순한 위임은 테스트할 필요가 없음

#### 데이터 문제

- 데이터가 이미 데이터베이스에 있다고 가정하는 것은 고통스러운 요리법
- 머신에 있는 데이터베이스라면 가장 간단한 경로는 테스트마다 깨끗한 데이터베이스로 시작하는 것

-------------

## 프로젝트에서 테스트

### 빠른 도입

- 단위 테스트와 같은 실천법을 배우는 것은 끊임없는 경계를 요구함
- 첫날부터 품질을 통제하며 개발하길 주장하면 갈등을 줄일 수 있음
- 단위 테스트는 이러한 품질 통제의 일부가 됨

### 팀과 같은 편 되기

- 어떤 개발자들은 TDD, 다른 사람들은 필요한 부분에만 단위 테스트를 주장함
- 팀이 같은 편이 되는 것은 중요함

#### 단위 테스트 표준 만들기

- 코드를 체크인하기 전에 어떤 테스트를 실행해야 할지 여부
- 테스트 클래스와 메서드의 이름 짓는 방식
- 햄크레스트 혹은 전통적인 단언 사용 여부
- AAA 사용 여부
- 선호하는 목 도구 선택
- 체크인 테스트를 실행할 때 콘솔에 출력을 허용할지 여부
- 단위 테스트 스위트에서 느린 테스트를 분명하게 식별하고 막을 방법

#### 리뷰로 표준 점수 높이기

- 어떻게 코드 리뷰를 할 것인가도 표준에 넣으면 좋음
  - 리뷰 세션을 통해 단위 테스트 작성자가 다른 팀원들에게 피드백을 요청할 수 있음
  - 페이건 검사 같은 기법을 사용하여 리뷰 절차를 공식화할 수도 있음
- 일부 팀들이 채택하는 다른 장치는 PR

### 지속적 통합으로 수렴

- A 개발자 로컬에선 돌아가고 B 개발자 로컬에선 안돌아감
- 단위 테스트는 이러한 모든 문제를 해결해 주지 않지만 일종의 표준
- 옛 사고방식의 최전선은 공유된 코드에 대해 야간 빌드(nightly build)를 수행하는 것
- CI는 코드를 더 자주 통합하고 그 결과를 매번 검증하는 것을 의미함
- 지속적 통합 서버라고 하는 도구의 지원을 받아야 함
- CI 서버가 어떤 가치를 제공하려면 빌드가 단위 테스트를 함께 수행해야 함
