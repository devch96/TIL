# 1장 JPA 소개

------------

## SQL을 직접 다룰 때 발생하는 문제점

### 반복, 반복 그리고 반복

- 데이터베이스는 객체 구조와는 다른 데이터 중심의 구조를 가지므로, 객체를 데이터베이스에 직접 저장하거나 조회할 수 없다.
- 개발자가 객체지향 어플리케이션과 데이터베이스 중간에서 SQL과 JDBC API를 사용해서 변환 작업을 직접 해주어야 한다.
- CRUD 같은 간단한 기능을 만들면서, SQL을 작성하고, JDBC API를 사용하는 비슷한 일을 계속해서 반복한다.

### SQL에 의존적인 개발

- 객체지향 적이 아닌 SQL에 의존하여 개발하게된다.
- 객체에 필드를 하나 추가할 때도 객체가 사용하는 CRUD 코드와 SQL 대부분을 변경해야 하는 문제가 발생한다.
- 진정한 의미의 계층 분할이 어렵다.
- 엔티티(비즈니스 요구사항을 모델링한 객체)를 신뢰할 수 없다.

### JPA와 문제 해결

- JPA를 사용하면 객체를 데이터베이스에 저장하고 관리할 때, 개발자가 직접 SQL을 작성하는 것이 아니라 JPA가 제공하는 API를 사용하면 된다.
-----------
<br>

## 패러다임의 불일치

- 관계형 데이터베이스는 데이터 중심으로 구조화되어 있고, 집합적인 사고를 요구한다.
그리고 객체지향에서 이야기하는 추상화, 상속, 다형성 같은 개념이 없다.
- 객체와 관계형 데이터베이스는 지향하는 목적이 서로 다르므로 둘의 기능과 표현 방법도 다르다.
- 이것을 객체와 관계형 데이터베이스의 패러다임 불일치 문제라 한다.
- **문제는 이런 객체와 관계형 데이터베이스 사이의 패러다임 불일치 문제를 해결하는 데 너무 많은 시간과 코드를 소비하는 데 있다.**

### 상속

- 객체는 상속이라는 기능이 있지만 테이블은 상속이라는 기능이 없다.
- 상속된 객체를 데이터베이스에 저장하려면 부모와 자식 객체를 분해해서 SQL을 작성해야 한다.
- 이러한 과정이 모두 패러다임의 불일치를 해결하려고 소모하는 비용이다.

### JPA와 상속

- 상속과 관련된 패러다임의 불일치 문제를 개발자 대신 해결해준다.
- 개발자는 마치 자바 컬렉션에 객체를 저장하듯이 JPA에게 객체를 저장하면 된다.
- 상속한 자식 객체를 저장하면 JPA는 부모와 자식으로 나누어 SQL을 실행한다.

### 연관관계

- 객체는 참조를 사용해서 다른 객체와 연관관계를 가지고 참조에 접근해서 연관된 객체를 조회한다.
    ```java
    Class{
        A a = new A();
    }
    ```
- 테이블은 외래 키를 사용해서 다른 테이블과의 연관관계를 가지고 조인을 사용해서 연관된 테이블을 조회한다.
- 참조와 외래 키 간의 패러다임 불일치는 극복하기 매우 어렵다.
- 또한 객체는 참조가 있는 방향으로만 조회할 수 있지만, 테이블은 외래 키 하나로 양방향 다 가능하다.


### 객체를 테이블에 맞추어 모델링 or 객체지향 모델링

- 객체를 테이블에 맞추어 모델링할 경우, 테이블에 저장하거나 조회할 때는 편리하지만, 객체에서 참조를 할 수 없다.
- 객체지향 모델링일 경우 객체의 참조는 쉬우나 테이블에 저장하거나 조회하기가 쉽지 않다.
- 객체 모델은 외래 키가 필요 없고, 참조만 있으면 된다. 테이블은 참조가 필요 없고, 외래 키만 있으면 되기 때문이다.
- 결국, 개발자가 중간에서 변환 역할을 해야 한다.

### JPA 와 연관관계

- JPA는 연관관계와 관련된 패러다임의 불일치 문제를 해결해준다.
- 객체의 참조를 외래 키로 변환하여 데이터베이스에 전달하고, 데이터베이스에서 외래 키로 조회한 것을 참조로 변환해준다.

### 객체 그래프 탐색

- 객체의 참조의 참조의 참조의 ... 이렇게 가는 것을 그래프 탐색이라 한다.
- 하지만 SQL을 직접 다루면 처음 실행하는 SQL에 따라 객체 그래프를 어디까지 탐색할 수 있는지 정해진다.
- 그래프 탐색의 범위를 알려면 SQL을 직접 확인해야 한다.

### JPA와 객체 그래프 탐색

- JPA는 연관된 객체를 사용하는 시점에 적절한 SELECT SQL 을 실행한다.
- 이 기능은 실제 객체를 사용하는 시점까지 데이터베이스 조회를 미룬다고 해서 지연 로딩(Lazy Loading) 이라 한다.
    ```java
    //처음 조회 시점에 SELECT MEMBER SQL
    Member member = jpa.find(Member.class, memberId);
    
    Order order = member.getOrder();
    order.getOrderDate(); //Order를 사용하는 시점에 SELECT ORDER SQL
    ```
- Member를 사용할 때 마다 Order를 사용할 경우, 한 테이블씩 조회하는 것 보다 Member를 조회하는 시점에 SQL 조인을 사용해서 함께 조회하는 것이 효과적이다.
이것을 즉시 로딩(Eager Loading) 이라 한다.
- JPA는 연관된 객체를 즉시 함께 조회할지 아니면 실제 사용되는 시점에 지연해서 조회할지를 간단한 설정으로 정의할 수 있다.

### 비교

- 데이터베이스는 기본 키의 값으로 각 로우(row)를 구분한다.
- 객체는 동일성(identity) 비교와 동등성(equality) 비교라는 두가지 비교 방법이 있다.
  - 동일성 비교: == 비교. 객체 인스턴스의 주소 값을 비교.
  - 동등성 비교: equals() 메소드를 통해 객체 내부의 값을 비교.
- 데이터베이스에서 같은 회원을 조회해도, 객체 측면에서 볼 때 둘은 다른 인스턴스이기 때문에 동일성 비교시 실패한다.

### JPA와 비교

- JPA는 같은 트랜잭션일 때 같은 객체가 조회되는 것을 보장한다.

### 정리

- 객체 모델과 관계형 데이터베이스 모델은 지향하는 패러다임이 서로 다르다.
- 이러한 패러다임의 차이를 극복하려고 개발자가 너무 많은 시간과 코드를 소비한다.
- 정교한 객체 모델링을 할수록 패러다임의 불일치 문제가 더 커진다.
- JPA는 패러다임의 불일치 문제를 해결해주고 정교한 객체 모델링을 유지하게 도와준다.

--------------

<br>

## JPA란 무엇인가?

- JPA(Java Persistence API)는 자바 진영의 ORM 기술 표준으로 어플리케이션과 JDBC 사이에서 동작한다.
- ORM(Object-Relational Mapping)은 객체와 관계형 데이터베이스를 매핑한다는 뜻이다.
- ORM 프레임워크는 단순히 SQL을 개발자 대신 생성해서 데이터베이스에 전달해주는 것뿐만 아니라
다양한 패러다임의 불일치 문제들도 해결해 준다.
- ORM 프레임워크 중 자바진영에서는 하이버네이트 프레임워크가 가장 많이 사용된다.

### JPA 소개

- EJB(Enterprise Java Beans) 3.0 에서 하이버네이트를 기반으로 새로운 자바 ORM 기술 표준을 만들었는데 이것이 바로 JPA다.
- JPA는 자바 ORM 기술에 대한 API 표준 명세다. 쉽게 이야기해서 인터페이스를 모아둔 것이다.
- Hibernate, EclipseLink 등이 있지만 Hibernate가 가장 대중적이다.

### 왜 JPA를 사용해야 하는가?

- 생산성
  - 지루하고 반복적인 코드와 CRUD용 SQL을 개발자가 직접 작성하지 않아도 된다.
  - 데이터베이스 설계 중심의 패러다임을 객체 설계 중심으로 역전 시킬 수 있다.
- 유지보수
  - SQL을 직접 다루면 엔티티에 필드를 하나만 추가해도 SQL과 매핑 코드를 모두 변경해야 한다.
  - JPA를 사용하면 이런 과정을 JPA가 대신 처리해주기 때문에 유지보수해야 하는 코드 수가 줄어든다.
  - JPA가 패러다임의 불일치 문제를 해결해주므로 객체지향 언어가 가진 장점을 활용할 수 있다.
- 패러다임의 불일치 해결
  - 상속, 연관관계, 객체 그래프 탐색, 비교하기와 같은 패러다임의 불일치 문제를 해결해준다.
- 성능
  - JPA는 어플리케이션과 데이터베이스 사이에서 동작한다.
  - 같은 트랜잭션 안에서 두 번 조회할 경우, SQL은 2번 다 각각 조회하지만 JPA는 한 번만 데이터베이스에 전달하고 두번째는 조회한 객체를 재사용한다.
- 데이터 접근 추상화와 벤더 독립성
  - 데이터베이스 기술에 종속되지 않고 어플리케이션과 데이터베이스 사이에 추상화된 접근 계층을 제공한다.
  - 데이터베이스를 변경할 경우 JPA에게 다른 데이터베이스를 사용한다고 알려주기만 하면 된다.

--------
