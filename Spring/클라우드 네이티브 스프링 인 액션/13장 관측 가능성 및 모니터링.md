# 관측 가능성 및 모니터링

- 모니터링이란 애플리케이션이 사용할 수 있는 원격 측정을 확인하고 실패 상태에 대한 경고를 정의하는 것
- 관측 가능성은 단순한 모니터링을 넘어 시스템에 대해 던질 수 있는 질문을 미리 정해놓지 않은 상태에서 어떠한 질문이라도
할 수 있는 상태에 도달하는 것을 목표로 함

----------

## 스프링 부트, 로키 및 플루언트 비트를 사용한 로깅

- 로그는 소프트웨어 애플리케이션에서 시간이 지남에 따라 발생한 일들에 대한 불연속적인 기록
- 이벤트의 유형이나 심각한 정도에 따라 분류됨
  - trace(추적)
  - debug(디버그)
  - info(정보)
  - warn(경고)
  - error(오류)
- 프로덕션 환경에서는 가장 심각한 이벤트만 기록하지만 디버깅이 필요할 때는 로그 수준을 일시적으로 변경할 수 있는 유연한 매커니즘
- 전통적으로 로그는 호스트 컴퓨터에 파일로 저장하기 때문에 애플리케이션에서 파일 이름 규칙, 파일 순환, 파일 크기와 같은 설정을 해야 했음
- 클라우드에서는 로그를 표준 출력으로 스트림되는 이벤트로 처리할 것을 권장함

### 스프링 부트를 사용한 로깅

- 스프링 부트는 로그백, 로그4j2, 커먼스 로깅, 자바 유틸 로깅 등 일반적인 로깅 프레임워크를 기본적으로 지원하도록 자동 설정되어 있음
  - 로그백이 기본 설정되어 있지만 SLF4J(Simple Logging Facade For Java) 에서 제공하는 추상화덕분에 다른 라이브러리로 쉽게 변경할 수 있음

#### 스프링 부트 로깅 설정

- 이벤트 로그는 추적, 디버그, 정보, 경고, 오류 수준으로 분류하는데 수준이 올라갈 수록 세부 정보는 점점 줄어들고 중요도는 점점 높아짐
  - 스프링 부트는 정보 이상의 수준(정보, 경고, 오류)을 로그로 기록하도록 기본 설정되어 있음
- 로거(logger)는 로그 이벤트를 생성하는 클래스
- 설정 속성을 통해 로거의 수준을 정할 수 있고, 전체 설정을 적용하거나 특정 패키지 또는 클래스를 대상으로 정할 수도 있음

```yaml
logging:
  level:
    io.github.resilience4j: debug
```

- 여러 개의 로거를 동시에 설정해야 할 경우 하나의 로그 그룹으로 묶고 이 그룹에 대한 설정을 적용할 수 있음
  - 스프링 부트는 web과 sql이라는 두 가지 사전 정의된 로그 그룹이 있지만 직접 정의 가능

```yaml
logging:
  group:
    circuitbreaker: io.github.resilience4j, org.springframework.cloud.circuitbrea
  level:
    circuitbraker: info
```

- 기본 설정상 이벤트 로그는 발생 날짜 및 시간, 로그 수준, 프로세스 식별자(PID), 이벤트 발생 스레드 이름, 로거 이름, 로그 메시지 등 필수적인 정보를 제공함
- logging.pattern 설정 속성 그룹을 통해 변경할 수 있음

#### 스프링 부트 애플리케이션에 로그 추가

- 프로젝트에 사용된 프레임워크와 라이브러리에 대한 로거를 설정하는 것 외에도 코드 내에서도 해당되는 곳에 이벤트 로그를 정의해야 함

```java
private static final Logger log = LoggerFactory.getLogger(BookController.class);

log.info("Fetching the list of books in the catalog");
```

### 로키, 플루언트 비트, 그라파나로 로그 관리하기

- 기존 애플리케이션은 문제가 발생하면 호스트 머신에 저장된 로그 파일에 의존함
- 클라우드 네이티브 애플리케이션은 동적인 환경에 배포되고 복제되며 배포에서 삭제까지 수명 주기도 제각각이기에 모든 애플리케이션에서
로그를 수집하여 집계, 저장, 검색이 가능한 중앙 구성 요소로 전송해야 함
- 그라파나 스택의 구성 요소 중에서 로그 저장 및 검색을 위해서는 로키, 로그 수집 및 집계를 위해서는 플루언트 비트, 로그 데이터 시각화 및 쿼리를
위해서는 그라파나 사용

```yaml
version: "3.8"
services:
  grafana:
    image: grafana/grafana:9.1.2
    container_name: grafana
    depends_on:
      - loki
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=user
      - GF_SECURITY_ADMIN_PASSWORD=password
    volumes:
      - ./observability/grafana/datasource.yml:/etc/grafana/provisioning/datasource/datasource.yml        
      - ./observability/grafana/dashboards:/etc/grafana/provisioning/datasource/dashboards        
      - ./observability/grafana/grafana.ini:/etc/grafana/provisioning/datasource/grafana.ini
  loki:
    image: grafana/loki:2.6.1
    container_name: loki
    depends_on:
      - fluent-bit
    ports:
      - "3100:3100"

  fluent-bit:
    image: grafana/fluent-bit-plugin-loki:2.6.1-amd64
    container_name: fluent-bit
    ports:
      - "24224:24224"
    environment:
      - LOKI_URL=http://loki:3100/loki/api/v1/push
    volumes:
      - ./observability/fluent-bit/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
```

- 도커 플랫폼 자체는 각 컨테이너의 로그 이벤트를 수신하고 지정된 서비스로 전달함
  - 컨테이너에서 직접 로깅 드라이버를 설정할 수 있음

```yaml
version: "3.8"
services:
  catalog-service:
    depends_on:
      - fluent-bit
      - polar-keycloak
      - polar-postgres
    image: "catalog-service"
    container_name: "catalog-service"
    logging:
      driver: fluent # 컨테이너 로깅 드라이버 설정
      options:
        fluentd-address: 127.0.0.1:24224 # 로그를 전달할 플루언트 비트 인스턴스의 주소
```

---------

## 스프링 부트 액추에이터와 쿠버네티스를 사용한 상태 프로브

- 클라우드 네이티브 애플리케이션은 자신의 상태에 대한 정보를 제공하고 문제가 생겼을 때 모니터링 도구와 배포 플랫폼이 이를
감지해 그에 따른 조치를 취할 수 있어야 함
- 스프링 부트 애플리케이션의 경우 액추에이터 라이브러리를 활용해 애플리케이션 및 데이터베이스, 이벤트 브로커, 설정 서버와 같이 애플리케이션이
사용하는 구성 요소에 대한 세부 정보를 /actuator/health HTTP 엔드포인트를 통해 제공
  - 무단으로 액세스하지 않도록 스프링 보안을 사용해야 함

### 액추에이터를 통한 스프링 부트 애플리케이션 상태 프로브 정의

```groovy
dependencies {
  implemenation 'org.springframework.boot:spring-boot-starter-actuator'
}
```

- 기본적으로 스프링 부트 액추에이터는 전체 상태만 반환함
- 애플리케이션 속성을 통해 애플리케이션에서 사용하는 여러 구성 요소에 구체적인 정보를 제공하도록 설정할 수 있음

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health
  endpoint:
    health:
      show-details: always
      show-components: always
```

### 스프링 부트 및 쿠버네티스에서 상태 프로브 설정

- 스프링 부트 액추에이터는 애플리케이션이 쿠버네티스 환경에서 실행되는 시기를 자동으로 감지하고 활성 및 준비 상태를 반환하도록 상태 프로브를 활성화함
  - 활성 상태
    - 애플리케이션이 활성 상태에 있지 않다면 문제가 있는 내부 상태로 진입했고 복구할 수 없다는 것을 의미
    - 쿠버네티스는 재시작을 시도하도록 기본 설정되어 있음
  - 준비 상태
    - 구성 요소를 초기화하는 중이거나 과부하로 인해 새 요청을 처리할 수 없음을 의미
    - 새 요청을 수락할 준비가 될 때까지 해당 인스턴스로의 요청 전달을 중단

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health
  endpoint:
    health:
      show-details: always
      show-components: always
  probes:
    enabled: true
```

- 스프링 부트의 준비 상태 프로브는 외부 구성 요소에 의존하지 않지만 외부 시스템을 준비 상태 프로브에 포함할지 여부를 결정할 수 있음

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health
  endpoint:
    health:
      show-details: always
      show-components: always
  probes:
    enabled: true
  group:
    readiness:
      include: readinessState,redis
```