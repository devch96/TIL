# 권한 부여 구성: 제한 적용

- 운영 단계 애플리케이션에서 모든 요청에 동일한 규칙을 적용하는 경우는 많지 않고, 일부 엔드포인트는 특정 사용자만 호출할 수 있고
나머지 엔드포인트는 모든 사용자가 호출할 수 있는 경우가 많다.
- 권한 부여 구성을 적용할 요청을 선택하는 데는 선택기 메서드를 사용한다.
- 스프링 시큐리티에는 세 유형의 선택기 메서드가 있다.
  - MVC 선택기
    - 경로에 MVC 식을 이용해 엔드포인트를 선택한다.
  - 앤트 선택기
    - 경로에 앤트 식을 이용해 엔드포인트를 선택한다.
  - 정규식 선택기
    - 경로에 정규식(regex)을 이용해 엔드포인트를 선택한다.

-------------

## 선택기 메서드로 엔드포인트 선택

```java
http.authorizeRequests().mvcMatchers("/hello").hasRole("ADMIN")
.mvcMatchers("/ciao").hasRole("MANAGER");
```
- 모든 규칙을 명시적으로 지정하는 것이 좋다.
  - 규칙 외의 나머지 엔드포인트에 대해 접근을 기본적으로 허용하지만, 명시하는 것이 좋다.

```java
http.authorizeRequests().mvcMatchers("/hello").hasRole("ADMIN")
.mvcMatchers("/ciao").hasRole("MANAGER")
.anyRequest().permitAll();
```
- "/hola" 라는 엔드포인트가 새로 생겼을 시 권한 없이 가능.
- 하지만 비밀번호를 같이 보낸다면 401 권한 없음 에러가 나옴.
  - curl http://localhost:8080/hola <- 성공
  - curl -u bill:abcde http://localhost:8080/hola <- 401 에러
- 이유는 권한 부여 이전에 인증을 진행하기 때문.
- 권한 부여 필터는 /hola 경로에 대한 모든 요청을 허용하지만 애플리케이션은 권한 부여보다 먼저 인증 놀리를 실행하므로
인증 필터는 요청을 권한 부여 필터로 전달하지 않고 401 권한 없음으로 응답한다.

------------

## MVC 선택기로 권한을 부여할 요청 선택

- 이 선택기는 표준 MVC 구문으로 경로를 지정하며 @RequestMapping, @GetMapping, @PostMapping 등의 어노테이션으로
엔드포인트 매핑을 작성할 때의 구문과 동일하다.
- 다음 두 메서드로 MVC 선택기를 선언할 수 있다.
  - mvcMatchers(HttpMethod method, String... patterns)
    - 제한을 적용할 HTTP 방식과 경로를 모두 지정할 수 있다.
    - 같은 경로에 대해 HTTP 방식별로 다른 제한을 적용할 때 유용하다.
  - mvcMatchers(String... patterns)
    - 경로만을 기준으로 권한 부여 제한을 적용할 때 더 쉽고 간단하게 이용할 수 있다.
    - 이 메서드를 이용하면 자동으로 해당 경로의 모든 HTTP 방식에 제한이 적용된다.
- 경로 그룹에는 항상 같은 권한 부여 규칙을 적용하고, 같은 그룹에 새 경로를 추가할 때는 권한 부여 구성을 변경할 필요가 없기를 원할 수 있는데
이럴 때는 ** 연산자를 이용하면 된다.
  - "/a/b/**"
- 경로 이름 중간에 ** 연산자를 사용할 수 있다.
- 경로 이름을 하나만 일치하게 하려면 & 문자를 하나만 지정한다.
  - a/*/c는 a/b/c 및 a/d/c와 일치하지만, a/b/d/c와는 일치하지 않는다.
- MVC 선택기로 경로 일치에 이용되는 일반적인 식
  - /a
    - /a 경로만
  - /a/*
    - '*' 연산자는 한 경로 이름만 대체
  - /a/**
    - ** 연산자는 여러 경로 이름 대체
  - /a/{param}
    - 주어진 경로 매개 변수를 포함한 /a 경로에 적용
  - /a/{param:regex}
    - 매개 변수 값과 주어진 정규식이 일치할 때만 주어진 경로 매개 변수를 포함한 /a 경로에 적용

-----------

## 앤트 선택기로 권한을 부여할 요청 선택

- 스프링은 엔드포인트와 경로를 비교하기 위해 앤트에서 차용한 MVC 식을 이용하므로 앤트 선택기의 구문은 MVC 선택기의 구문과 같지만
중요한 차이점이 있다.
- 앤트 선택기에는 다음의 세 메서드를 이용한다.
  - antMatchers(HttpMethod method, String patterns)
    - 제한을 적용할 HTTP 방식과 경로를 참조할 앤트 패턴을 모두 지정할 수 있다.
    - 같은 경로 그룹에 대해 HTTP 방식별로 다른 제한을 적용할 때 유용하다.
  - antMatchers(String patterns)
    - 경로만을 기준으로 권한 부여 제한을 적용할 때 더 쉽고 간단하게 이요할 수 있다.
  - antMatchers(HttpMethod method)
    - 경로와 관계없이 특정 HTTP 방식을 지정할 수 있다.
- MVC 선택기로 /hello 경로에 대한 보안을 구성하면 /hello/ 경로도 자동으로 같은 규칙으로 보호된다.
  - 스프링부트 3 부터는 둘의 경로가 다른것으로 인식되어서 틀림. 책이 신 버전을 다루지 않아서 이렇게 작성된 것으로 보임.
- 앤트 선택기는 패턴에 대해 주어진 앤트 식을 그대로 적용하며 스프링의 미묘한 MVC 기능은 고려하지 않는다.

------------------

## 정규식 선택기로 권한을 부여할 요청 선택

- 앤트와 MVC 식으로는 해결할 수 없는 특정한 요구 사항이 있을 수 있다.
  - 경로에 특정한 기호나 문자가 있으면 모든 요청을 거부한다 와 같은 경우
- 정규식 선택기는 다음 두 메서드로 구현할 수 있다.
  - regexMatchers(HttpMethod method, String regex)
  - regetMatchers(String regex)
- 정규식은 경로에 대한 어떤 요구 사항이라도 지정할 수 있는 아주 강력한 툴이지만 읽기 어렵고 상당히 길어질 수 있으므로 마지막 수단으로
남겨두는 것이 좋다.

------------

## 요청

- 경로와 HTTP 방식에 따라 권한 부여 규칙을 구성할 요청을 지정한다.
- MVC와 앤트 선택기는 서로 비슷하며 일반적으로 이 중 하나를 선택해 권한 부여 제한을 적용할 요청을 지정할 수 있다.
- 요구 사항이 앤트나 MVC 식으로 해결하기에 너무 복잡할 때 정규식으로 구현할 수 있다.